<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(to top, #ec8f04, #f58c79);
            color: #f0f0f0;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        body.light-mode {
            background: linear-gradient(to top, #ec8f04, black);
        }

        .balance-container {
            margin-top: 60px;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .balance {
            font-size: 36px;
            margin: 20px 0;
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
        }

        .balance-icon {
            margin-right: 10px;
            color: #ec8f04;
        }

        .middle-container {
            margin-top: 20px;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .middle-container .button {
            width: 80px;
            height: 80px;
            background-color: #ec8f04;
            color: #333;
            border: none;
            border-radius: 70%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .button-label {
            display: block;
            color: #fff;
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
        }

        .button:hover {
            background-color: #ec8f04;
        }

        .switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .switch a {
            margin-left: 10px;
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            background-color: #19e2b0;
            border-radius: 5px;
        }

        .switch1 {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            align-items: center;
        }
        .switch1 button {
            background: linear-gradient(to top, #ec8f04, #000000 50%);
            border: none;
            color: white;
            padding: 5px 10px;
            font-size: 10px;
            border-radius: 15px;
            margin-top: 60px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: 0.3s ease;
        }

        body.light-mode .switch1 button {
            background:linear-gradient(to top, #ec8f04, #f58c79 50%);
        }

        .bottom-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            padding: 10px;
            box-sizing: border-box;
            z-index: 1000;
            border-radius: 20px;
            overflow: hidden;
            background-color: #222;
            display: flex;
            justify-content: space-around;
        }

        .bottom-banner .button {
            width: 50px;
            height: 50px;
            background-color: #ec8f04;
            color: #000;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 10px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s, transform 0.3s;
        }

        .bottom-banner .button:hover {
            background-color: #ec8f04;
            transform: scale(1.1);
        }

        .button-label {
            display: block;
            color: #fff;
            text-align: center;
            font-size: 12px;
            margin-top: 3px;
        }

        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        #adsgram-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
        }

        .card {
            background-color: #000000;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            color: #fff;
            box-shadow: 0 4px 8px rgba(228, 21, 21, 0.3);
            position: relative;
            height: 120px;
            width: 90%;
            max-width: 320px;
            margin: 0 auto;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .daily2k {
            font-size: 16px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .acc-name {
            font-size: 16px;
            font-weight: lighter;
            position: absolute;
            bottom: 25px;
            right: 15px;
        }

        .acc-number {
            font-size: 16px;
            font-weight: lighter;
            position: absolute;
            bottom: 25px;
            left: 15px;
        }

        .balance-amount {
            font-size: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #user-full-name {
            font-size: 16px;
            font-weight: bold;
            position: absolute;
            bottom: 10px;
            right: 20px;
        }

        .profile-container {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
        }

        .button.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }

        .button.loading i {
            visibility: hidden;
        }

        .button.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-top: -8px;
            margin-left: -8px;
            border: 2px solid transparent;
            border-top-color: #000;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }

        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }
            to {
                transform: rotate(1turn);
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid transparent;
            border-top-color: #ec8f04;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: #fff;
            font-size: 18px;
            font-weight: bold;
        }

        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }
            to {
                transform: rotate(1turn);
            }
        }

        .increase-limit-btn {
            background-color: #ec8f04;
            color: #fff;
            border: none;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-bottom: -100px;
            width: 100px;
            height: 38px;
        }

        .increase-limit-btn:hover {
            background-color: #d07c03;
        }

        .increase-limit-btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }

        .weekly-contest-button {
            position: absolute;
            background-attachment: fixed;
            left: 20px;
            top: 320px;
            z-index: 10;
            text-align: center;
        }

        .glowing-button {
            background-color: #af320c;
            color: #dd860b;
            border: none;
            margin-left: 13px;
            border-radius: 100%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(236, 140, 4, 0.8), 0 0 20px rgba(236, 140, 4, 0.6);
            transition: box-shadow 0.3s ease;
            animation: glow-zoom 1.5s infinite alternate;
        }

        .glowing-button i {
            font-size: 14px;
        }

        .glowing-button:hover {
            box-shadow: 0 0 20px rgb(255, 9, 9), 0 0 30px rgba(236, 4, 4, 0.8);
        }

        .button-label {
            display: block;
            color: #fff;
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
        }

        @keyframes glow-zoom {
            0% {
                box-shadow: 0 0 10px rgba(236, 140, 4, 0.8), 0 0 20px rgba(236, 140, 4, 0.6);
                transform: scale(1);
            }
            100% {
                box-shadow: 0 0 20px rgba(236, 140, 4, 1), 0 0 30px rgba(236, 140, 4, 0.8);
                transform: scale(1.1);
            }
        }

        .right-side-buttons {
            position: absolute;
            right: 10px;
            top: 420px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auction-button,
        .livestream-button {
            text-align: center;
        }

        .glowing-button.auction {
            background-color: #0ca1af;
            color: #0bdddd;
        }

        .glowing-button.auction:hover {
            box-shadow: 0 0 20px rgb(9, 225, 255), 0 0 30px rgba(4, 236, 225, 0.8);
        }

        .glowing-button.livestream {
            background-color: #af0c7a;
            color: #dd0b9e;
        }

        .glowing-button.livestream:hover {
            box-shadow: 0 0 20px rgb(255, 9, 234), 0 0 30px rgba(236, 4, 221, 0.8);
        }

        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            opacity: 0;
            visibility: hidden;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            transition: opacity 0.3s ease;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
        }

        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
        }

        .tour-tooltip {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            max-width: 250px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            display: none;
            animation: tooltipPop 0.3s ease-out;
        }

        .tour-tooltip::before {
            content: '';
            position: absolute;
            border: 8px solid transparent;
        }

        .tour-tooltip.top::before {
            border-top-color: rgba(0, 0, 0, 0.9);
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
        }

        .tour-controls {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tour-controls button {
            background-color: #ec8f04;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .tour-controls button:hover {
            background-color: #d07c03;
        }

        @keyframes tooltipPop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .tour-highlight {
            position: relative;
            z-index: 1999;
        }

        .tour-highlight::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid #ec8f04;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.5;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .glowing-button.locked {
            background-color: #666 !important;
            cursor: not-allowed !important;
            animation: none !important;
            box-shadow: none !important;
        }

        .glowing-button.locked:hover {
            box-shadow: none !important;
            background-color: #666 !important;
        }

        .fa-lock {
            color: #fff;
            font-size: 14px;
        }

        @media screen and (max-width: 768px) {
            .balance-container {
                margin-top: 40px;
            }

            .middle-container {
                padding: 10px;
            }

            .middle-container .button {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }

            .bottom-banner .button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .button-label {
                font-size: 10px;
            }

            .right-side-buttons {
                right: 5px;
                top: 380px;
            }

            .weekly-contest-button {
                left: 10px;
                top: 280px;
            }
        }

        @media screen and (min-width: 1440px) {
            .balance-container {
                margin-top: 80px;
            }

            .card {
                max-width: 400px;
            }

            .middle-container {
                gap: 30px;
            }
        }
    </style>
</head>

<body>
    <script>
        (function(d, z, s) {
            s.src = 'https://' + d + '/401/' + z;
            try {
                (document.body || document.documentElement).appendChild(s);
            } catch (e) {}
        })('groleegni.net', 8579388, document.createElement('script'));
    </script>

    <div class="profile-container">
        <img id="profile-pic" src="R.png" alt="Profile Picture" style="width: 50px; height: 50px; border-radius: 50%;">
        <span id="username" style="color: #fff; margin-left: 10px;">User Name</span>
    </div>
    <div class="switch1" style="top: 20px; left: 20px;">
        <button id="modeToggle" data-tooltip="Switch between light and dark mode">switch mode</button>
    </div>
    <div class="balance-container">
        <div class="balance">
            <div class="card">
                <div class="balance-amount">
                    <span>2KCoin balance</span>
                    <span id="balance">0</span>
                </div>
                <div class="card-header">
                    <span class="daily2k">DAILY2K</span>
                </div>
                <div id="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <span class="acc-name">User Name.</span>
                <span id="user-full-name"></span>
                <span class="acc-number">****2KCoin.</span>
            </div>
        </div>
    </div>

    <div class="switch">
        <a href="advertise.html" data-tooltip="Create your own advertising campaign">Advertise</a>
    </div>

    <div class="middle-container">
        <div>
            <button class="button" onclick="window.location.href='task.html'" data-tooltip="Complete tasks to earn 2KCoins">
                <i class="fas fa-tasks" alt="Tasks Icon"></i>
            </button>
            <span class="button-label">Tasks</span>
        </div>
        <div class="weekly-contest-button">
            <button class="glowing-button" onclick="window.location.href='weeklycontest.html'" data-tooltip="Join weekly contests for big rewards">
                <i class="fas fa-trophy" alt="Trophy Icon"></i>
            </button>
            <span class="button-label">Weekly Contest</span>
        </div>
        <div>
            <button class="button" onclick="handleWatchAdsClick()" id="watchAdsButton" data-tooltip="Watch ads to earn 2KCoins">
                <i class="fas fa-ad" alt="Ads Icon"></i>
            </button>
            <span class="button-label">Watch Ads</span>
            <button onclick="handleIncreaseWatchAdsLimit()" id="increaseWatchAdsButton" class="increase-limit-btn" data-tooltip="Increase your daily ad watch limit">
                Increase Daily Limit
            </button>
        </div>
        <div>
            <button class="button" onclick="window.loadAdsterraAd()" data-tooltip="Visit links to earn 2KCoins">
                <i class="fas fa-paper-plane" alt="Direct Link Icon"></i>
            </button>
            <span class="button-label">Direct Link</span>
            <button onclick="handleIncreaseDirectLinkLimit()" id="increaseDirectLinkButton" class="increase-limit-btn" data-tooltip="Increase your daily direct link limit">
                Increase Daily Limit
            </button>
        </div>
        <div class="right-side-buttons">
            <div class="auction-button">
                <button class="glowing-button auction" onclick="window.location.href='auction.html'" data-tooltip="Bid on exclusive items">
                    <i class="fas fa-gavel" alt="Auction Icon"></i>
                </button>
                <span class="button-label">Auction</span>
            </div>
            <div class="livestream-button">
                <button class="glowing-button livestream" onclick="window.location.href='livestream.html'" data-tooltip="Watch and interact with live streams">
                    <i class="fas fa-video" alt="Livestream Icon"></i>
                </button>
                <span class="button-label">Live Stream</span>
            </div>
        </div>
    </div>

    <div class="bottom-banner">
        <div>
            <button class="button" onclick="window.location.href='profile.html'" data-tooltip="View and edit your profile">
                <i class="fas fa-user" alt="Profile Icon"></i>
            </button>
            <span class="button-label">Profile</span>
        </div>
        <div>
            <button class="button" onclick="window.location.href='withdraw.html'" data-tooltip="Withdraw your earned 2KCoins">
                <i class="fas fa-wallet" alt="Wallet Icon"></i>
            </button>
            <span class="button-label">Withdraw</span>
        </div>
        <div>
            <button class="button" onclick="window.location.href='friends.html'" data-tooltip="Connect with other users">
                <i class="fas fa-user-friends" alt="Friends Icon"></i>
            </button>
            <span class="button-label">Friends</span>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCpH_yjFtiib-QuaCnHy2qeVyXhXikWTFg",
            authDomain: "mydaily2kbot.firebaseapp.com",
            projectId: "mydaily2kbot",
            storageBucket: "mydaily2kbot.appspot.com",
            messagingSenderId: "967002689133",
            appId: "1:967002689133:web:e3a8d03eaf7cf2f1b7f964",
            measurementId: "G-2VNDPK8V4J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        function showLoading(show) {
            document.getElementById("loading").style.display = show ? "block" : "none";
        }

        async function loadUserData(userId) {
            showLoading(true);
            let userData = null;
            try {
                const userDocRef = doc(db, "users", userId);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    userData = docSnap.data();
                    console.log("User data:", userData);
                    document.getElementById("balance").textContent = userData.balance || 0;
                    document.getElementById("user-full-name").textContent = userData.username || "User";
                    
                    document.getElementById("profile-pic").src = userData.profilePic || "default/R.png";
                    document.getElementById("username").textContent = userData.username || "User Name";
                    
                    window.adUsage = userData.adUsage || { 
                        adsWatched: 0,
                        directLinksUsed: 0,
                        increaseLimitUsed: 0,
                        adsWatchLimit: 20,
                        directLinkLimit: 20
                    };
                } else {
                    console.error("User not found in Firestore.");
                    alert("Error: User data not found. Please contact support.");
                }
            } catch (error) {
                console.error("Error loading user data: ", error);
                alert("Error loading user data. Please try again later.");
            } finally {
                showLoading(false);
            }
            return userData;
        }

        function checkNewUser(userId) {
            const hasVisited = localStorage.getItem(`hasVisited_${userId}`);
            if (!hasVisited) {
                setTimeout(startTour, 1000);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadUserData(user.uid);
                await checkFeatureAccess();
                checkNewUser(user.uid);
                console.log("User object:", user);
            } else {
                console.log("User not logged in. Redirecting to login page.");
                window.location.href = 'login.html';
            }
        });

        async function loadAdCampaign() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please log in to watch ads and earn coins.");
                return;
            }

            if (window.adUsage.adsWatched >= (window.adUsage.adsWatchLimit || 20)) {
                alert("You have reached the daily limit for watching ads. Use 'Increase Ads Limit' to watch more.");
                return;
            }

            try {
                const campaignsCollection = collection(db, 'campaigns');
                const snapshot = await getDocs(campaignsCollection);
                const campaigns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (campaigns.length === 0) {
                    alert("No campaigns available.");
                    return;
                }

                const highViewCampaigns = campaigns.filter(c => c.viewpreference === 'high');
                const lowViewCampaigns = campaigns.filter(c => c.viewpreference !== 'high');

                let selectedCampaign;
                if (Math.random() < 0.7 && highViewCampaigns.length > 0) {
                    selectedCampaign = highViewCampaigns[Math.floor(Math.random() * highViewCampaigns.length)];
                } else if (lowViewCampaigns.length > 0) {
                    selectedCampaign = lowViewCampaigns[Math.floor(Math.random() * lowViewCampaigns.length)];
                } else {
                    selectedCampaign = campaigns[Math.floor(Math.random() * campaigns.length)];
                }

                if (!selectedCampaign.videoURL) {
                    console.error("No video URL found in the selected campaign.");
                    alert("Oops!You trying to watch ads too often.try again");
                    return;
                }

                const adContainer = document.createElement('div');
                adContainer.id = 'campaign-container';
                adContainer.innerHTML = `
                    <div class="video-wrapper">
                        <a href="createcampaign.html" class="publish-ads-button">Post Ads</a>
                        <video src="${selectedCampaign.videoURL}" autoplay muted playsinline></video>
                        <div class="banner">
                            <div class="logo-name">
                                <img src="${selectedCampaign.logoURL || 'default-logo.png'}" alt="Logo" class="logo">
                                <span>${selectedCampaign.name || 'App Name'}</span>
                            </div>
                            <a href="${selectedCampaign.link || '#'}" target="_blank" class="action-link">
                                ${selectedCampaign.type === 'application' ? 'Install App' : 'Visit Web'}
                            </a>
                        </div>
                    </div>
                `;
                document.body.appendChild(adContainer);

                adContainer.style.display = 'flex';
                adContainer.style.flexDirection = 'column';
                adContainer.style.alignItems = 'center';
                adContainer.style.justifyContent = 'center';
                adContainer.style.position = 'fixed';
                adContainer.style.top = '50%';
                adContainer.style.left = '50%';
                adContainer.style.transform = 'translate(-50%, -50%)';
                adContainer.style.zIndex = '1000';
                adContainer.style.backgroundColor = 'transparent';
                adContainer.style.padding = '10px';
                adContainer.style.borderRadius = '10px';
                adContainer.style.width = '90%';
                adContainer.style.maxWidth = '600px';

                const videoWrapper = adContainer.querySelector('.video-wrapper');
                videoWrapper.style.position = 'relative';
                videoWrapper.style.width = '100%';
                videoWrapper.style.height = 'auto';
                videoWrapper.style.overflow = 'hidden';

                const videoElement = adContainer.querySelector('video');
                videoElement.style.width = '100%';
                videoElement.style.height = 'auto';
                videoElement.style.borderRadius = '10px';
                videoElement.style.pointerEvents = 'none';

                const banner = adContainer.querySelector('.banner');
                banner.style.position = 'absolute';
                banner.style.bottom = '-100%';
                banner.style.left = '50%';
                banner.style.transform = 'translateX(-50%)';
                banner.style.width = '91%';
                banner.style.maxWidth = '500px';
                banner.style.display = 'flex';
                banner.style.justifyContent = 'space-between';
                banner.style.alignItems = 'center';
                banner.style.backgroundColor = 'rgba(51, 51, 51, 0.8)';
                banner.style.color = '#fff';
                banner.style.padding = '10px';
                banner.style.borderRadius = '5px';
                banner.style.transition = 'bottom 1.5s ease-in-out';

                const publishButton = adContainer.querySelector('.publish-ads-button');
                publishButton.style.position = 'absolute';
                publishButton.style.top = '-50px';
                publishButton.style.right = '10px';
                publishButton.style.padding = '8px 15px';
                publishButton.style.backgroundColor = '#ec8f04';
                publishButton.style.color = '#fff';
                publishButton.style.textDecoration = 'none';
                publishButton.style.borderRadius = '5px';
                publishButton.style.fontWeight = 'bold';
                publishButton.style.zIndex = '1002';
                publishButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                publishButton.style.transition = 'top 1.5s ease-in-out';
                publishButton.onmouseover = () => publishButton.style.backgroundColor = '#d07c03';
                publishButton.onmouseout = () => publishButton.style.backgroundColor = '#ec8f04';

                videoElement.addEventListener('play', () => {
                    setTimeout(() => {
                        banner.style.bottom = '10px';
                        publishButton.style.top = '10px';
                    }, 2000);
                });

                const logoName = adContainer.querySelector('.logo-name');
                logoName.style.display = 'flex';
                logoName.style.alignItems = 'center';

                const logo = adContainer.querySelector('.logo');
                logo.style.width = '30px';
                logo.style.height = '30px';
                logo.style.marginRight = '5px';

                const actionLink = adContainer.querySelector('.action-link');
                actionLink.style.backgroundColor = '#ec8f04';
                actionLink.style.color = '#fff';
                actionLink.style.padding = '5px 10px';
                actionLink.style.borderRadius = '5px';
                actionLink.style.textDecoration = 'none';
                actionLink.style.transition = 'background-color 0.3s';
                actionLink.onmouseover = () => actionLink.style.backgroundColor = '#d07c03';
                actionLink.onmouseout = () => actionLink.style.backgroundColor = '#ec8f04';

                videoElement.addEventListener('ended', async () => {
                    const campaignDocRef = doc(db, 'campaigns', selectedCampaign.id);
                    await updateDoc(campaignDocRef, {
                        views: (selectedCampaign.views || 0) + 1
                    });

                    const claimButton = document.createElement('button');
                    claimButton.textContent = 'Claim 20 2KCoins';
                    claimButton.style.position = 'absolute';
                    claimButton.style.bottom = '150px';
                    claimButton.style.left = '50%';
                    claimButton.style.transform = 'translateX(-50%)';
                    claimButton.style.backgroundColor = '#28a745';
                    claimButton.style.color = '#fff';
                    claimButton.style.padding = '10px 20px';
                    claimButton.style.border = 'none';
                    claimButton.style.borderRadius = '5px';
                    claimButton.style.cursor = 'pointer';
                    claimButton.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.3)';
                    claimButton.style.transition = 'background-color 0.3s, transform 0.3s';
                    claimButton.onmouseover = () => claimButton.style.backgroundColor = '#218838';
                    claimButton.onmouseout = () => claimButton.style.backgroundColor = '#28a745';
                    claimButton.onclick = async () => {
                        window.adUsage.adsWatched++;
                        await updateAdUsage(user.uid, window.adUsage);
                        await updateBalance(user.uid, 20);
                        adContainer.remove();
                        alert("You've earned 20 2KCoins!");
                    };
                    videoWrapper.appendChild(claimButton);
                });

            } catch (error) {
                console.error("Error loading campaigns:", error);
                alert("Error loading campaigns. Please try again later.");
            }
        }

        async function checkRewardConfirmation(userId) {
            const checkRewardUrl = `https://vercel-backend-liart.vercel.app/api/check-reward?userId=${userId}`;

            const checkReward = async () => {
                try {
                    const response = await fetch(checkRewardUrl);
                    const data = await response.json();

                    if (data.rewarded) {
                        alert("Ad completed. You've earned 10 2KCoins!");
                        await updateBalance(userId, 10);
                        document.getElementById('campaign-container').remove();
                    } else {
                        setTimeout(checkReward, 5000);
                    }
                } catch (error) {
                    console.error('Error checking reward:', error);
                    setTimeout(checkReward, 5000);
                }
            };

            checkReward();
        }

        async function loadAdsterraAd() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please log in to watch ads and earn coins.");
                return;
            }

            if (window.adUsage.directLinksUsed >= (window.adUsage.directLinkLimit || 20)) {
                alert("You have reached the daily limit for direct links. Use 'Increase Link Limit' to use more.");
                return;
            }

            try {
                localStorage.setItem('directLinkStartTime', Date.now().toString());
                
                const link = document.createElement('a');
                link.href = 'https://www.profitablecpmrate.com/e9ap8ata9?key=4899d6aafddc404944002ca071108e1c';
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                startRewardCheck();
                
            } catch (error) {
                console.error("Error processing direct link:", error);
                alert("Error processing direct link. Please try again later.");
            }
        }

        function startRewardCheck() {
            const startTime = localStorage.getItem('directLinkStartTime');
            if (!startTime) return;

            const checkInterval = setInterval(async () => {
                const timeSpent = Date.now() - parseInt(startTime);
                if (timeSpent >= 10000) {
                    clearInterval(checkInterval);
                    const user = auth.currentUser;
                    if (user) {
                        localStorage.removeItem('directLinkStartTime');
                        
                        window.adUsage.directLinksUsed++;
                        await updateAdUsage(user.uid, window.adUsage);
                        await updateBalance(user.uid, 10);
                        
                        const newBalance = parseInt(document.getElementById("balance").textContent) + 10;
                        document.getElementById("balance").textContent = newBalance;
                        
                        alert("Directlink used! You've earned 10 2KCoins!");
                    }
                }
            }, 1000);

            setTimeout(() => clearInterval(checkInterval), 60000);
        }

        async function updateAdUsage(userId, adUsage) {
            showLoading(true);
            try {
                const userDocRef = doc(db, "users", userId);
                await updateDoc(userDocRef, { adUsage });
            } catch (error) {
                console.error("Error updating ad usage: ", error);
                alert("Error updating ad usage. Please try again later.");
            } finally {
                showLoading(false);
            }
        }

        async function updateBalance(userId, amount) {
            showLoading(true);
            try {
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const newBalance = (userDoc.data().balance || 0) + amount;
                    await updateDoc(userDocRef, { balance: newBalance });
                    document.getElementById("balance").textContent = newBalance;
                } else {
                    console.error("User not found.");
                    alert("Error: Unable to update balance. Please contact support.");
                }
            } catch (error) {
                console.error("Error updating balance: ", error);
                alert("Error updating balance. Please try again later.");
            } finally {
                showLoading(false);
            }
        }

        window.loadAdgramAd = loadAdCampaign;
        window.loadAdsterraAd = loadAdsterraAd;
        window.updateBalance = updateBalance;

        async function loadCampaigns() {
            const highViewsGallery = document.getElementById('highViewsGallery');
            const lowViewsGallery = document.getElementById('lowViewsGallery');
            highViewsGallery.innerHTML = '';
            lowViewsGallery.innerHTML = '';

            try {
                const snapshot = await db.collection('campaigns').get();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log("Campaign data:", data);

                    if (data.videoURL && data.videoURL.trim() !== '' && !data.hasOwnProperty('balance')) {
                        const videoContainer = document.createElement('div');
                        videoContainer.className = 'campaign';
                        videoContainer.dataset.preference = data.viewPreference;

                        const videoElement = document.createElement('video');
                        videoElement.src = data.videoURL;
                        videoElement.controls = true;

                        const videoName = document.createElement('p');
                        videoName.textContent = data.name;

                        videoContainer.appendChild(videoElement);
                        videoContainer.appendChild(videoName);

                        if (data.viewPreference === 'high') {
                            highViewsGallery.appendChild(videoContainer);
                        } else {
                            lowViewsGallery.appendChild(videoContainer);
                        }
                    } else {
                        console.warn(`Missing or empty videoURL for document: ${doc.id}`);
                    }
                });
            } catch (error) {
                console.error("Error loading campaigns:", error);
            }
        }

        window.handleWatchAdsClick = async function() {
            const button = document.getElementById('watchAdsButton');
            
            button.classList.add('loading');
            
            try {
                await loadAdCampaign();
            } catch (error) {
                console.error('Error loading ad:', error);
                alert('Failed to load ad. Please try again.');
            } finally {
                button.classList.remove('loading');
            }
        }

        const currentMode = localStorage.getItem('mode') || 'dark';
        if (currentMode === 'light') {
            document.body.classList.add('light-mode');
        }

        const modeToggle = document.getElementById('modeToggle');
        modeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            const newMode = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            localStorage.setItem('mode', newMode);
            
            modeToggle.textContent = newMode === 'light' ? 'Light Mode' : 'Dark Mode';
        });
        
        modeToggle.textContent = currentMode === 'light' ? 'Light Mode' : 'Dark Mode';

        const tourSteps = [
            {
                element: '.fa-tasks',
                title: 'Tasks',
                content: 'Complete various tasks to earn 2KCoins'
            },
            {
                element: '.fa-trophy',
                title: 'Weekly Contest',
                content: 'Participate in weekly contests for big rewards'
            },
            {
                element: '.fa-ad',
                title: 'Watch Ads',
                content: 'Watch advertisements to earn 2KCoins'
            },
            {
                element: '.fa-paper-plane',
                title: 'Direct Link',
                content: 'Visit links to earn more 2KCoins'
            },
            {
                element: '.fa-gavel',
                title: 'Auction',
                content: 'Bid on exclusive items using your 2KCoins'
            },
            {
                element: '.fa-video',
                title: 'Live Stream',
                content: 'Watch and interact with live streams'
            },
            {
                element: '.fa-user',
                title: 'Profile',
                content: 'View and edit your profile settings'
            },
            {
                element: '.fa-wallet',
                title: 'Withdraw',
                content: 'Withdraw your earned 2KCoins'
            },
            {
                element: '.fa-user-friends',
                title: 'Friends',
                content: 'Connect with other users'
            },
            {
                element: '#modeToggle',
                title: 'Switch Mode',
                content: 'Toggle between light and dark mode for better viewing'
            },
            {
                element: '.switch a',
                title: 'Advertise',
                content: 'Create your own advertising campaign and reach our users'
            }
        ];

        function createTooltip() {
            const tooltip = document.createElement('div');
            tooltip.className = 'tour-tooltip';
            document.body.appendChild(tooltip);
            return tooltip;
        }

        function startTour() {
            let currentStep = 0;
            const tooltip = createTooltip();

            function showStep(step) {
                const tourStep = tourSteps[step];
                const element = document.querySelector(tourStep.element);
                
                document.querySelectorAll('.tour-highlight').forEach(el => {
                    el.classList.remove('tour-highlight');
                });

                element.classList.add('tour-highlight');

                const rect = element.getBoundingClientRect();
                tooltip.className = `tour-tooltip ${tourStep.position}`;
                tooltip.innerHTML = `
                    <h3 style="margin: 0 0 10px 0">${tourStep.title}</h3>
                    <p style="margin: 0">${tourStep.content}</p>
                    <div class="tour-controls">
                        ${step > 0 ? '<button class="prev-btn">Previous</button>' : ''}
                        <button class="next-btn">${step === tourSteps.length - 1 ? 'Got it!' : 'Next'}</button>
                    </div>
                `;

                tooltip.style.display = 'block';
                tooltip.style.left = `${rect.left + rect.width/2 - tooltip.offsetWidth/2}px`;
                tooltip.style.top = `${rect.top - tooltip.offsetHeight - 20}px`;

                const nextBtn = tooltip.querySelector('.next-btn');
                const prevBtn = tooltip.querySelector('.prev-btn');

                nextBtn.onclick = () => {
                    if (step === tourSteps.length - 1) {
                        endTour();
                    } else {
                        showStep(step + 1);
                    }
                };

                if (prevBtn) {
                    prevBtn.onclick = () => showStep(step - 1);
                }
            }

            function endTour() {
                tooltip.remove();
                document.querySelectorAll('.tour-highlight').forEach(el => {
                    el.classList.remove('tour-highlight');
                });
                localStorage.setItem(`hasVisited_${auth.currentUser.uid}`, 'true');
            }

            showStep(0);
        }

        async function checkFeatureAccess() {
            try {
                const controlDocRef = doc(db, "featureAccess", "control");
                const docSnap = await getDoc(controlDocRef);

                if (docSnap.exists()) {
                    const controls = docSnap.data();
                    
                    const weeklyContestBtn = document.querySelector('.weekly-contest-button .glowing-button');
                    if (!controls.weeklyContestUnlocked) {
                        weeklyContestBtn.innerHTML = `<i class="fas fa-lock"></i>`;
                        weeklyContestBtn.onclick = () => alert('This feature is currently locked');
                        weeklyContestBtn.style.backgroundColor = '#666';
                        weeklyContestBtn.style.cursor = 'not-allowed';
                    }

                    const auctionBtn = document.querySelector('.auction-button .glowing-button');
                    if (!controls.auctionUnlocked) {
                        auctionBtn.innerHTML = `<i class="fas fa-lock"></i>`;
                        auctionBtn.onclick = () => alert('This feature is currently locked');
                        auctionBtn.style.backgroundColor = '#666';
                        auctionBtn.style.cursor = 'not-allowed';
                    }

                    const livestreamBtn = document.querySelector('.livestream-button .glowing-button');
                    if (!controls.liveStreamUnlocked) {
                        livestreamBtn.innerHTML = `<i class="fas fa-lock"></i>`;
                        livestreamBtn.onclick = () => alert('This feature is currently locked');
                        livestreamBtn.style.backgroundColor = '#666';
                        livestreamBtn.style.cursor = 'not-allowed';
                    }
                }
            } catch (error) {
                console.error("Error checking feature access:", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadUserData(user.uid);
                await checkFeatureAccess();
                checkNewUser(user.uid);
                console.log("User object:", user);
            } else {
                console.log("User not logged in. Redirecting to login page.");
                window.location.href = 'login.html';
            }
        });

        const newStyles = document.createElement('style');
        newStyles.textContent = `
            .glowing-button.locked {
                background-color: #666 !important;
                cursor: not-allowed !important;
                animation: none !important;
                box-shadow: none !important;
            }

            .glowing-button.locked:hover {
                box-shadow: none !important;
                background-color: #666 !important;
            }

            .fa-lock {
                color: #fff;
                font-size: 14px;
            }
        `;
        document.head.appendChild(newStyles);
    </script>
    <script type='text/javascript' src='https://pl25145596.profitablecpmrate.com/a1/91/a1/a191a1a71e1bfd8cf2b8b436068db02a.js'></script>
</body>
</html>
