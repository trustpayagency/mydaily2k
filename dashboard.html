<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(to top, #ec8f04, #f58c79);
            color: #f0f0f0;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            height: 100%;
            width: 100%;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        body.light-mode {
            background: linear-gradient(to top, #ec8f04, black);
        }

        .balance-container {
            margin-top: -100px;
            text-align: center;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .balance {
            font-size: 36px;
            margin: 20px 0;
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
        }

        .balance-icon {
            margin-right: 10px;
            color: #ec8f04;
        }

        .middle-container {
            margin-top: -350px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            width: 100%;
            flex-grow: 1;
        }

        .middle-container .button {
            width: 80px;
            height: 80px;
            background-color: #ec8f04;
            color: #333;
            border: none;
            border-radius: 70%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        } 

        .button:hover {
            background-color: #ec8f04;
        }

        .switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .switch a {
            margin-left: 10px;
            color: white;
            text-decoration: none;
            padding: 5px 5px; 
            border-radius: 15px;
        }

        .switch1 {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            align-items: center;
        }
        .switch1 button {
            background: linear-gradient(to top, #ec8f04, #000000 50%);
            border: none;
            color: white;
            padding: 5px 10px;
            font-size: 10px;
            border-radius: 15px;
            margin-top: 60px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: 0.3s ease;
        }

        body.light-mode .switch1 button {
            background:linear-gradient(to top, #ec8f04, #f58c79 50%);
        }

        .bottom-banner {
    border-radius: 20px; /* Curved edges */
    overflow: hidden; /* Ensure content fits within the border */
    background-color: #222; /* Change background color */
    padding: 13px; /* Adjust padding */
    width: 75%; /* Set width */
    margin: 0px auto; /* Center the banner */
    position: fixed; /* Keep it fixed at the bottom */
    bottom: 20px;
    left: 50%; /* Center horizontally */
    transform: translateX(-50%); /* Adjust position to perfectly center */
    z-index: 1;
    display: flex;
    justify-content: space-around;
}
 
        .bottom-banner .button {
            width: 50px; /* Adjusted size for consistency */
            height: 50px;
            background-color: #ec8f04;
            color: #000;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 10px; /* Adjusted padding */
            font-size: 24px; /* Adjusted icon size */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s, transform 0.3s;
        }

        .bottom-banner .button:hover {
            background-color: #ec8f04;
            transform: scale(1.1);
        }

        .button-label {
            display: block;
            color: #fff; /* White color for visibility */
            text-align: center;
            font-size: 12px; /* Appropriate size for labels */
            margin-top: 3px; /* Space between icon and label */
        } 


        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        #adsgram-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
        } 
        .card {
            background-color: #000000; /* Card background color */
            border-radius: 10px; /* Rounded corners */
            padding: 20px; /* Padding inside the card */
            display: flex; /* Flexbox for layout */
            flex-direction: column; /* Stack elements vertically */
            justify-content: space-between; /* Space between header and username */
            color: #fff; /* Text color */
            box-shadow: 0 4px 8px rgba(228, 21, 21, 0.3); /* Shadow effect */
            position: relative; /* Positioning for absolute elements */
            height: 120px; /* Fixed height for the card */
            width: 320px;
        }

        .card-header {
            display: flex; /* Flexbox for layout */
            justify-content: space-between; /* Space between balance and daily2k */
             align-items: flex-start; /* Align items to the start */
        }

    .daily2k {
        font-size: 16px; /* Font size for the user's name */
        font-weight: bold; /* Bold text */
        position: absolute; /* Absolute positioning */
        top: 10px; /* Position from the bottom */
        right: 10px; /* Position from the right */
    }
    .acc-name {
        font-size: 16px; /* Font size for the user's name */
        font-weight: lighter; /* Bold text */
        position: absolute; /* Absolute positioning */
        bottom: 25px; /* Position from the bottom */
        right: 15px;
    }
    
    .acc-number {
        font-size: 16px; /* Font size for the user's name */
        font-weight: lighter; /* Bold text */
        position: absolute; /* Absolute positioning */
        bottom: 25px; /* Position from the bottom */
        left: 15px;
    }

    .balance-amount {
        font-size: 20px; /* Font size for the balance amount */
        display: flex; /* Flexbox for layout */
        flex-direction: column; /* Stack elements vertically */
        align-items: flex-start; /* Align items to the start */
    }

    #user-full-name {
        font-size: 16px; /* Font size for the user's name */
        font-weight: bold; /* Bold text */
        position: absolute; /* Absolute positioning */
        bottom: 10px; /* Position from the bottom */
        right: 20px; /* Position from the right */
    }
    .profile-container {
    position: absolute;
    top: 20px;
    left: 20px;
    display: flex;
    align-items: center;
}

.button.loading {
    position: relative;
    pointer-events: none;
    opacity: 0.8;
}

.button.loading i {
    visibility: hidden;
}

.button.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-top: -8px;
    margin-left: -8px;
    border: 2px solid transparent;
    border-top-color: #000;
    border-radius: 50%;
    animation: button-loading-spinner 1s ease infinite;
}

@keyframes button-loading-spinner {
    from {
        transform: rotate(0turn);
    }
    to {
        transform: rotate(1turn);
    }
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid transparent;
    border-top-color: #ec8f04;
    border-radius: 50%;
    animation: button-loading-spinner 1s ease infinite;
    margin-bottom: 15px;
}

.loading-text {
    color: #fff;
    font-size: 18px;
    font-weight: bold;
}

@keyframes button-loading-spinner {
    from {
        transform: rotate(0turn);
    }
    to {
        transform: rotate(1turn);
    }
}

 

.weekly-contest-button {
    position: absolute; /* Position it relative to the parent */
    background-attachment: fixed;
    left: 20px; /* Adjust as needed */
    top: 320px; /* Adjust to position above the Tasks button */
    z-index: 10; /* Ensure it appears above other elements */
    text-align: center; /* Center the text below the button */
}

.glowing-button {
    background-color: #af320c; /* Button color */
    color: #dd860b; /* Text color */
    border: none;
    margin-left: 13px;
    border-radius: 100%; /* Make it round */
    width: 40px; /* Set width */
    height: 40px; /* Set height */
    cursor: pointer;
    display: flex; /* Use flexbox for alignment */
    align-items: center; /* Center icon vertically */
    justify-content: center; /* Center icon horizontally */
    box-shadow: 0 0 10px rgba(236, 140, 4, 0.8), 0 0 20px rgba(236, 140, 4, 0.6); /* Glowing effect */
    transition: box-shadow 0.3s ease;
    animation: glow-zoom 1.5s infinite alternate; /* Add animation */
}

.glowing-button i {
    font-size: 14px; /* Adjust icon size */
}

.glowing-button:hover {
    box-shadow: 0 0 20px rgb(255, 9, 9), 0 0 30px rgba(236, 4, 4, 0.8); /* Enhanced glow on hover */
}

.button-label {
    display: block; /* Ensure label is on a new line */
    color: #fff; /* White color for visibility */
    text-align: center; /* Center the label */
    font-size: 12px; /* Appropriate size for labels */
    margin-top: 5px; /* Space between icon and label */
}

/* New keyframes for glowing and zooming effect */
@keyframes glow-zoom {
    0% {
        box-shadow: 0 0 10px rgba(236, 140, 4, 0.8), 0 0 20px rgba(236, 140, 4, 0.6);
        transform: scale(1);
    }
    100% {
        box-shadow: 0 0 20px rgba(236, 140, 4, 1), 0 0 30px rgba(236, 140, 4, 0.8);
        transform: scale(1.1);
    }
} 

/* Add these new styles */
.right-side-buttons {
    position: absolute;
    right: 10px;
    top: 320px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.auction-button,
.livestream-button {
    text-align: center;
}

.glowing-button.auction {
    background-color: #0ca1af;
    color: #0bdddd;
}

.glowing-button.auction:hover {
    box-shadow: 0 0 20px rgb(9, 225, 255), 0 0 30px rgba(4, 236, 225, 0.8);
}

.glowing-button.livestream {
    background-color: #af0c7a;
    color: #dd0b9e;
}

.glowing-button.livestream:hover {
    box-shadow: 0 0 20px rgb(255, 9, 234), 0 0 30px rgba(236, 4, 221, 0.8);
}
 
/* Tour tooltip styles */
.tour-tooltip {
    position: fixed;
    background-color: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 2000;
    max-width: 250px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    display: none;
    animation: tooltipPop 0.3s ease-out;
}

.tooltip-arrow {
    position: absolute;
    width: 0;
    height: 0;
    border-style: solid;
}

.tour-tooltip.bottom .tooltip-arrow {
    border-width: 0 10px 10px 10px;
    border-color: transparent transparent rgba(0, 0, 0, 0.9) transparent;
    top: -10px;
}

.tour-tooltip.top .tooltip-arrow {
    border-width: 10px 10px 0 10px;
    border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
    bottom: -10px;
}

.tour-controls {
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tour-controls button {
    background-color: #ec8f04;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.tour-controls button:hover {
    background-color: #d07c03;
}

@keyframes tooltipPop {
    0% {
        transform: scale(0.8);
        opacity: 0;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Highlight effect for current tour element */
.tour-highlight {
    position: relative;
    z-index: 1999;
}

.tour-highlight::after {
    content: '';
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    border: 2px solid #ec8f04;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.5;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Added styles for locked buttons */
.glowing-button.locked {
    background-color: #666 !important;
    cursor: not-allowed !important;
    animation: none !important;
    box-shadow: none !important;
}

.glowing-button.locked:hover {
    box-shadow: none !important;
    background-color: #666 !important;
}

.fa-lock {
    color: #fff;
    font-size: 14px;
}

/* Full-screen overlay styling */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.campaign-content {
    max-width: 90%;
    max-height: 90%;
    overflow: auto;
    background: #0303036e;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
    position: relative;
}

.campaign-image, .video-wrapper video {
    max-width: 100%;
    max-height: 100%;
    display: block;
    margin: 0 auto;
}

.banner {
    text-align: center;
    margin-top: 10px;
}

.logo-name {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.logo {
    max-width: 50px;
    max-height: 50px;
}

.action-link {
    display: inline-block;
    margin-top: 10px;
    padding: 10px 20px;
    background: #19e2b0;
    color: #fff;
    text-decoration: none;
    border-radius: 5px;
}

.countdown-timer {
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    color: #333;
}

.reward-message {
    font-size: 18px;
    font-weight: bold;
    color: #19e2b0;
    margin-top: 20px;
    text-align: center;
}

.close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 24px;
    color: #333;
    cursor: pointer;
}

/* Add styles for the banner */
.install-banner {
    background-color: #ce1212ce; /* Banner color */
    color: white; /* Text color */
    width:  50%; /* Reduced width */
    max-width: 300px; /* Maximum width for larger screens */
    padding: 10px; /* Padding */
    text-align: center; /* Center text */
    position: fixed; /* Fixed position */
    top: 20px; /* Position from the top */
    left: 50%; /* Center horizontally */
    transform: translateX(-50%); /* Center the banner */
    z-index: 1000; /* Ensure it appears above other elements */
    display: none; /* Initially hidden */
    border-radius: 8px; /* Rounded corners */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Subtle shadow */
}
    </style>
    </head>

<body>
    <script>
        (function(d, z, s) {
            s.src = 'https://' + d + '/401/' + z;
            try {
                (document.body || document.documentElement).appendChild(s);
            } catch (e) {}
        })('groleegni.net', 8579388, document.createElement('script'));
    </script> 
 
    <div class="profile-container">
        <img id="profile-pic" src="R.png" alt="Profile Picture" style="width: 50px; height: 50px; border-radius: 50%;">
        <span id="username" style="color: #fff; margin-left: 10px;">User Name</span>
    </div>
    <div class="switch1" style="top: 20px; left: 20px;">
        <button id="modeToggle">switch mode</button>
    </div> 
        <!-- Add the install banner -->
        <div class="install-banner" id="installBanner">
            Install this app to your home screen and earn 300 2KCoins! 
            <button id="installButton" style="background: black; border: none; font-style: bold; color: white; cursor: pointer;">Install</button>
            <div id="instruction" style="display: none; margin-top: 5px;">
                <p>To add to your home screen:</p>
                <ul style="list-style-type: none; padding: 0; margin: 0;">
                    <li>1. Tap the share icon (usually at the bottom of your browser).</li>
                    <li>2. Select "Add to Home Screen".</li>
                </ul>
            </div>
            <button id="closeBanner" style="background: black; border: none; color: white; cursor: pointer;">X</button>
        </div>
    <div class="balance-container">
        <div class="balance">
            <div class="card">
                <div class="balance-amount">
                    <span>2KCoin balance</span>
                    <span id="balance">0</span> 
                </div>
                <div class="card-header">
                    <span class="daily2k">DAILY2K</span>
                </div>
                <div id="loading">
                    <i class="fas fa-spinner fa-spin"></i>  
                </div> 
                 <span class="acc-name">User Name.</span>
                 <span id="user-full-name"></span> <!-- Placeholder for user's full name -->
                 <span class="acc-number">****2KCoin.</span>
                </div>
            </div>
        </div>
    </div>  

    <div class="switch">
        <a href="advertisedashboard.html"style="background: linear-gradient(to right, #19e2b0, #f58c79);">switch to Advertise</a> 
    </div>
     
    <div class="middle-container">
        <div>
            <button class="button" onclick="window.location.href='task.html'">
                <i class="fas fa-tasks" alt="Tasks Icon"></i>
            </button>
            <span class="button-label" style="margin-bottom: 20px; right: 20px;">Tasks</span>
        </div>
        <div class="weekly-contest-button">
            <button class="glowing-button" onclick="window.location.href='weeklycontest.html'">
                <i class="fas fa-trophy" alt="Trophy Icon"></i>
            </button>
            <span class="button-label">Weekly Contest</span>
        </div>
        <div>
            <button class="button" onclick="handleWatchAdsClick()" id="watchAdsButton">
                <i class="fas fa-ad" alt="Ads Icon"></i>
            </button>
            <span class="button-label">Watch Ads</span>
        </div>
        <div>
            <button class="button" onclick="window.loadAdsterraAd()">
                <i class="fas fa-paper-plane" alt="Direct Link Icon"></i>
            </button>
            <span class="button-label">Direct Link</span>
        </div>
        <div class="right-side-buttons">
            <div class="auction-button">
                <button class="glowing-button auction" onclick="window.location.href='auction.html'">
                    <i class="fas fa-gavel" alt="Auction Icon"></i>
                </button>
                <span class="button-label">Auction</span>
            </div>
            <div class="livestream-button">
                <button class="glowing-button livestream" onclick="window.location.href='livestream.html'">
                    <i class="fas fa-video" alt="Livestream Icon"></i>
                </button>
                <span class="button-label">Live Stream</span>
            </div>
        </div>
    </div>

    <div class="bottom-banner">
        <div>
            <button class="button" onclick="window.location.href='profile.html'">
                <i class="fas fa-user" alt="Profile Icon"></i>
            </button>
            <span class="button-label">Profile</span>
        </div>
        <div>
            <button class="button" onclick="window.location.href='withdraw.html'">
                <i class="fas fa-wallet" alt="Wallet Icon"></i>
            </button>
            <span class="button-label">Withdraw</span>
        </div>
        <div>
            <button class="button" onclick="window.location.href='friends.html'">
                <i class="fas fa-user-friends" alt="Friends Icon"></i>
            </button>
            <span class="button-label">Friends</span>
        </div>
    </footer>



    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js"; 

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCpH_yjFtiib-QuaCnHy2qeVyXhXikWTFg",
            authDomain: "mydaily2kbot.firebaseapp.com",
            projectId: "mydaily2kbot",
            storageBucket: "mydaily2kbot.appspot.com",
            messagingSenderId: "967002689133",
            appId: "1:967002689133:web:e3a8d03eaf7cf2f1b7f964",
            measurementId: "G-2VNDPK8V4J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        function showLoading(show) {
            document.getElementById("loading").style.display = show ? "block" : "none";
        } 

        async function loadUserData(userId) {
    showLoading(true);
    let userData = null; // Initialize userData variable
    try {
        const userDocRef = doc(db, "users", userId);
        const docSnap = await getDoc(userDocRef);

        if (docSnap.exists()) {
            userData = docSnap.data(); // Store user data
            console.log("User data:", userData); // Log user data
            document.getElementById("balance").textContent = userData.balance || 0;
            document.getElementById("user-full-name").textContent = userData.username || "User"; // Set full name
            
            // Set profile picture and username
            document.getElementById("profile-pic").src = userData.profilePic || "default/R.png"; // Set profile picture URL
            document.getElementById("username").textContent = userData.username || "User Name"; // Set username
            
            // Store ad usage limits
            window.adUsage = userData.adUsage || { 
                adsWatched: 0,
                directLinksUsed: 0,
                increaseLimitUsed: 0,
                adsWatchLimit: 20,    // Default limit
                directLinkLimit: 20    // Default limit
            };
        } else {
            console.error("User not found in Firestore.");
            alert("Error: User data not found. Please contact support.");
        }
    } catch (error) {
        console.error("Error loading user data: ", error);
        alert("Error loading user data. Please try again later.");
    } finally {
        showLoading(false);
    }
    return userData; // Return the user data
}

        function checkNewUser(userId) {
            const hasVisited = localStorage.getItem(`hasVisited_${userId}`);
            if (!hasVisited) {
                // Start the tour after a short delay to ensure all elements are loaded
                setTimeout(startTour, 1000);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadUserData(user.uid);
                await checkFeatureAccess(); // Add this line
                checkNewUser(user.uid);
                console.log("User object:", user);
            } else {
                console.log("User not logged in. Redirecting to login page.");
                window.location.href = 'login.html';
            }
        });   
        async function loadAdCampaign() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please log in to watch ads and earn coins.");
                return;
            }

            if (window.adUsage.adsWatched >= (window.adUsage.adsWatchLimit || 20)) {
                alert("You have reached the daily limit for watching ads. Use 'Increase Ads Limit' to watch more.");
                return;
            }

            try {
                const campaignsCollection = collection(db, 'campaigns');
                const snapshot = await getDocs(campaignsCollection);
                const campaigns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                console.log("Fetched campaigns:", campaigns); // Debugging: Log fetched campaigns

                if (campaigns.length === 0) {
                    alert("No campaigns available.");
                    return;
                }

                const userDevice = getUserDevice();
                const validCampaigns = campaigns.filter(campaign => {
                    return campaign.contentURL && campaign.name && campaign.contentType && 
                           (campaign.type !== 'balance') && 
                           (campaign.type === 'app' ? (campaign.platform === userDevice || campaign.platform === 'both') : true);
                });

                if (validCampaigns.length === 0) {
                    alert("No campaigns available for your platform.");
                    return;
                }

                // Separate campaigns by view preference
                const highPreferenceCampaigns = validCampaigns.filter(campaign => campaign.viewPreference === 'high');
                const lowPreferenceCampaigns = validCampaigns.filter(campaign => campaign.viewPreference !== 'high');

                // Weighted random selection
                let selectedCampaign;
                if (Math.random() < 0.7 && highPreferenceCampaigns.length > 0) {
                    selectedCampaign = highPreferenceCampaigns[Math.floor(Math.random() * highPreferenceCampaigns.length)];
                } else if (lowPreferenceCampaigns.length > 0) {
                    selectedCampaign = lowPreferenceCampaigns[Math.floor(Math.random() * lowPreferenceCampaigns.length)];
                } else {
                    // Fallback if no campaigns match the preference
                    selectedCampaign = validCampaigns[Math.floor(Math.random() * validCampaigns.length)];
                }

                console.log("Selected campaign:", selectedCampaign); // Debugging: Log selected campaign

                displayCampaign(selectedCampaign);

            } catch (error) {
                console.error("Error loading campaigns:", error);
                alert("Error loading campaigns. Please try again later.");
            }
        }

        async function checkRewardConfirmation(userId) {
            const checkRewardUrl = `https://vercel-backend-liart.vercel.app/api/check-reward?userId=${userId}`;

            const checkReward = async () => {
                try {
                    const response = await fetch(checkRewardUrl);
                    const data = await response.json();

                    if (data.rewarded) {
                        alert("Ad completed. You've earned 10 2KCoins!");
                        await updateBalance(userId, 10);
                        document.getElementById('campaign-container').remove();
                    } else {
                        // Check again after 5 seconds
                        setTimeout(checkReward, 5000);
                    }
                } catch (error) {
                    console.error('Error checking reward:', error);
                    // Retry after 5 seconds
                    setTimeout(checkReward, 5000);
                }
            };

            checkReward();
        }

        async function loadAdsterraAd() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please log in to watch ads and earn coins.");
                return;
            }

            if (window.adUsage.directLinksUsed >= (window.adUsage.directLinkLimit || 20)) {
                alert("You have reached the daily limit for direct links. Use 'Increase Link Limit' to use more.");
                return;
            }

            try {
                // Store start time in localStorage
                localStorage.setItem('directLinkStartTime', Date.now().toString());
                
                // Open in new tab
                const link = document.createElement('a');
                link.href = 'https://www.profitablecpmrate.com/e9ap8ata9?key=4899d6aafddc404944002ca071108e1c';
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Start checking for reward immediately
                startRewardCheck();
                
            } catch (error) {
                console.error("Error processing direct link:", error);
                alert("Error processing direct link. Please try again later.");
            }
        }

        // New function to handle reward checking
        function startRewardCheck() {
            const startTime = localStorage.getItem('directLinkStartTime');
            if (!startTime) return;

            const checkInterval = setInterval(async () => {
                const timeSpent = Date.now() - parseInt(startTime);
                if (timeSpent >= 10000) { // Changed to 5 seconds
                    clearInterval(checkInterval);
                    const user = auth.currentUser;
                    if (user) {
                        // Clear the stored time
                        localStorage.removeItem('directLinkStartTime');
                        
                        // Update usage and balance
                        window.adUsage.directLinksUsed++;
                        await updateAdUsage(user.uid, window.adUsage);
                        await updateBalance(user.uid, 10);
                        
                        // Update the balance display immediately
                        const newBalance = parseInt(document.getElementById("balance").textContent) + 10;
                        document.getElementById("balance").textContent = newBalance;
                        
                        alert("Directlink used! You've earned 10 2KCoins!");
                    }
                }
            }, 1000); // Check every second

            // Clear interval after 1 minute if something goes wrong
            setTimeout(() => clearInterval(checkInterval), 60000);
        }

        async function updateAdUsage(userId, adUsage) {
            showLoading(true);
            try {
                const userDocRef = doc(db, "users", userId);
                await updateDoc(userDocRef, { adUsage });
            } catch (error) {
                console.error("Error updating ad usage: ", error);
                alert("Error updating ad usage. Please try again later.");
            } finally {
                showLoading(false);
            }
        }

        async function updateBalance(userId, amount) {
            showLoading(true);
            try {
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const newBalance = (userDoc.data().balance || 0) + amount;
                    await updateDoc(userDocRef, { balance: newBalance });
                    document.getElementById("balance").textContent = newBalance;
                } else {
                    console.error("User not found.");
                    alert("Error: Unable to update balance. Please contact support.");
                }
            } catch (error) {
                console.error("Error updating balance: ", error);
                alert("Error updating balance. Please try again later.");
            } finally {
                showLoading(false);
            }
        }

        window.loadAdgramAd = loadAdCampaign;
        window.loadAdsterraAd = loadAdsterraAd;
        window.updateBalance = updateBalance;

        // Load campaigns
        async function loadCampaigns() {
            const highViewsGallery = document.getElementById('highViewsGallery');
            const lowViewsGallery = document.getElementById('lowViewsGallery');
            highViewsGallery.innerHTML = '';
            lowViewsGallery.innerHTML = '';

            try {
                const snapshot = await db.collection('campaigns').get();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log("Campaign data:", data); // Log the data to check its structure

                    // Check if videoURL exists and is not empty, and ignore documents with a balance field
                    if (data.videoURL && data.videoURL.trim() !== '' && !data.hasOwnProperty('balance')) {
                        const videoContainer = document.createElement('div');
                        videoContainer.className = 'campaign';
                        videoContainer.dataset.preference = data.viewPreference;

                        const videoElement = document.createElement('video');
                        videoElement.src = data.videoURL;
                        videoElement.controls = true;

                        const videoName = document.createElement('p');
                        videoName.textContent = data.name;

                        videoContainer.appendChild(videoElement);
                        videoContainer.appendChild(videoName);

                        // Append to the appropriate gallery based on viewPreference
                        if (data.viewPreference === 'high') {
                            highViewsGallery.appendChild(videoContainer);
                        } else {
                            lowViewsGallery.appendChild(videoContainer);
                        }
                    } else {
                        console.warn(`Missing or empty videoURL for document: ${doc.id}`);
                    }
                });
            } catch (error) {
                console.error("Error loading campaigns:", error);
            }
        }

        // Make handleWatchAdsClick globally accessible
        window.handleWatchAdsClick = async function() {
            const button = document.getElementById('watchAdsButton');
            
            // Add loading state
            button.classList.add('loading');
            
            try {
                // Call your existing ad loading function
                await loadAdCampaign();
            } catch (error) {
                console.error('Error loading ad:', error);
                alert('Failed to load ad. Please try again.');
            } finally {
                // Remove loading state
                button.classList.remove('loading');
            }
        }

        // Check localStorage for the user's mode preference
        const currentMode = localStorage.getItem('mode') || 'dark';
        if (currentMode === 'light') {
            document.body.classList.add('light-mode'); // Apply light mode if set
        }

        const modeToggle = document.getElementById('modeToggle');
        modeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode'); // Toggle light mode class
            // Save the current mode to localStorage
            const newMode = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            localStorage.setItem('mode', newMode);
            
            // Update button text based on the current mode
            modeToggle.textContent = newMode === 'light' ? 'Light Mode' : 'Dark Mode';
        });
        
        // Set initial button text based on the current mode
        modeToggle.textContent = currentMode === 'light' ? 'Light Mode' : 'Dark Mode';

        // Add this after Firebase initialization
        const tourSteps = [
            {
                element: '.fa-tasks',
                title: 'Tasks',
                content: 'Complete various tasks to earn 2KCoins'
            },
            {
                element: '.fa-trophy',
                title: 'Weekly Contest',
                content: 'Participate in weekly contests for big rewards'
            },
            {
                element: '.fa-ad',
                title: 'Watch Ads',
                content: 'Watch advertisements to earn 2KCoins'
            },
            {
                element: '.fa-paper-plane',
                title: 'Direct Link',
                content: 'Visit links to earn more 2KCoins'
            },
            {
                element: '.fa-gavel',
                title: 'Auction',
                content: 'Bid on exclusive items using your 2KCoins'
            },
            {
                element: '.fa-video',
                title: 'Live Stream',
                content: 'Watch and interact with live streams'
            },
            {
                element: '.fa-user',
                title: 'Profile',
                content: 'View and edit your profile settings'
            },
            {
                element: '.fa-wallet',
                title: 'Withdraw',
                content: 'Withdraw your earned 2KCoins'
            },
            {
                element: '.fa-user-friends',
                title: 'Friends',
                content: 'Connect with other users'
            },
            {
                element: '#modeToggle',
                title: 'Switch Mode',
                content: 'Toggle between light and dark mode for better viewing'
            },
            {
                element: '.switch a',  // Targeting the advertise link
                title: 'Advertise',
                content: 'Create your own advertising campaign and reach our users'
            }
        ];

        function createTooltip() {
            const tooltip = document.createElement('div');
            tooltip.className = 'tour-tooltip';
            document.body.appendChild(tooltip);
            return tooltip;
        }

        function startTour() {
            let currentStep = 0;
            const tooltip = createTooltip();

            function showStep(step) {
                const tourStep = tourSteps[step];
                const element = document.querySelector(tourStep.element);
                
                if (!element) {
                    console.warn(`Tour element not found: ${tourStep.element}`);
                    if (step === tourSteps.length - 1) {
                        endTour();
                    } else {
                        showStep(step + 1);
                    }
                    return;
                }

                // Remove previous highlight
                document.querySelectorAll('.tour-highlight').forEach(el => {
                    el.classList.remove('tour-highlight');
                });

                // Add highlight to current element
                element.classList.add('tour-highlight');

                // Position and show tooltip
                const rect = element.getBoundingClientRect();
                tooltip.className = 'tour-tooltip';
                tooltip.innerHTML = `
                    <div class="tooltip-arrow"></div>
                    <h3 style="margin: 0 0 10px 0">${tourStep.title}</h3>
                    <p style="margin: 0">${tourStep.content}</p>
                    <div class="tour-controls">
                        ${step > 0 ? '<button class="prev-btn">Previous</button>' : ''}
                        <button class="next-btn">${step === tourSteps.length - 1 ? 'Got it!' : 'Next'}</button>
                    </div>
                `;

                // Position tooltip with bounds checking
                tooltip.style.display = 'block';
                
                // Calculate positions
                const tooltipRect = tooltip.getBoundingClientRect();
                let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                let top = rect.bottom + 15; // Reduced gap between element and tooltip

                // Ensure tooltip stays within viewport
                left = Math.max(10, Math.min(left, window.innerWidth - tooltipRect.width - 10));
                
                // If tooltip would go below viewport, show it above the element instead
                if (top + tooltipRect.height > window.innerHeight - 10) {
                    top = rect.top - tooltipRect.height - 15;
                    tooltip.classList.add('top');
                } else {
                    tooltip.classList.add('bottom');
                }

                tooltip.style.left = `${left}px`;
                tooltip.style.top = `${top}px`;

                // Position the arrow
                const arrow = tooltip.querySelector('.tooltip-arrow');
                let arrowLeft = rect.left + (rect.width / 2) - left - 10; // 10 is half the arrow width
                arrowLeft = Math.max(20, Math.min(arrowLeft, tooltipRect.width - 20));
                arrow.style.left = `${arrowLeft}px`;

                // Add button listeners
                const nextBtn = tooltip.querySelector('.next-btn');
                const prevBtn = tooltip.querySelector('.prev-btn');

                if (nextBtn) {
                    nextBtn.onclick = () => {
                        if (step === tourSteps.length - 1) {
                            endTour();
                        } else {
                            showStep(step + 1);
                        }
                    };
                }

                if (prevBtn) {
                    prevBtn.onclick = () => showStep(step - 1);
                }
            }

            function endTour() {
                if (tooltip) {
                    tooltip.remove();
                }
                document.querySelectorAll('.tour-highlight').forEach(el => {
                    el.classList.remove('tour-highlight');
                });
                if (auth.currentUser) {
                    localStorage.setItem(`hasVisited_${auth.currentUser.uid}`, 'true');
                }
            }

            // Add error handling for starting the tour
            try {
                showStep(0);
            } catch (error) {
                console.error('Error starting tour:', error);
                endTour();
            }
        }

        async function checkFeatureAccess() {
            try {
                // Change from "control" to "controls" to match dashboardadmin.html
                const controlDocRef = doc(db, "featureAccess", "controls");
                const docSnap = await getDoc(controlDocRef);

                if (docSnap.exists()) {
                    const controls = docSnap.data();
                    
                    // Weekly Contest Lock
                    const weeklyContestBtn = document.querySelector('.weekly-contest-button .glowing-button');
                    if (!controls.weeklyContestUnlocked) {
                        weeklyContestBtn.innerHTML = `<i class="fas fa-lock"></i>`;
                        weeklyContestBtn.onclick = () => alert('This feature is currently locked');
                        weeklyContestBtn.classList.add('locked');
                    } else {
                        weeklyContestBtn.innerHTML = `<i class="fas fa-trophy"></i>`; // Restore trophy icon
                        weeklyContestBtn.onclick = () => window.location.href='weeklycontest.html';
                        weeklyContestBtn.classList.remove('locked');
                    }

                    // Auction Lock
                    const auctionBtn = document.querySelector('.auction-button .glowing-button');
                    if (!controls.auctionUnlocked) {
                        auctionBtn.innerHTML = `<i class="fas fa-lock"></i>`;
                        auctionBtn.onclick = () => alert('This feature is currently locked');
                        auctionBtn.classList.add('locked');
                    } else {
                        auctionBtn.innerHTML = `<i class="fas fa-gavel"></i>`; // Restore gavel icon
                        auctionBtn.onclick = () => window.location.href='auction.html';
                        auctionBtn.classList.remove('locked');
                    }

                    // Livestream Lock
                    const livestreamBtn = document.querySelector('.livestream-button .glowing-button');
                    if (!controls.liveStreamUnlocked) {
                        livestreamBtn.innerHTML = `<i class="fas fa-lock"></i>`;
                        livestreamBtn.onclick = () => alert('This feature is currently locked');
                        livestreamBtn.classList.add('locked');
                    } else {
                        livestreamBtn.innerHTML = `<i class="fas fa-video"></i>`; // Restore video icon
                        livestreamBtn.onclick = showLivestreamOverlay;
                        livestreamBtn.classList.remove('locked');
                    }
                }
            } catch (error) {
                console.error("Error checking feature access:", error);
            }
        }

        // Add this after Firebase initialization
        const controlsRef = doc(db, "featureAccess", "controls");
        onSnapshot(controlsRef, (doc) => {
            if (doc.exists()) {
                checkFeatureAccess();
            }
        });

        // Update the onAuthStateChanged listener to include feature check
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadUserData(user.uid);
                await checkFeatureAccess(); // Add this line
                checkNewUser(user.uid);
                console.log("User object:", user);
            } else {
                console.log("User not logged in. Redirecting to login page.");
                window.location.href = 'login.html';
            }
        });

        // Add CSS for locked buttons
        const newStyles = document.createElement('style');
        newStyles.textContent = `
            .glowing-button.locked {
                background-color: #666 !important;
                cursor: not-allowed !important;
                animation: none !important;
                box-shadow: none !important;
            }

            .glowing-button.locked:hover {
                box-shadow: none !important;
                background-color: #666 !important;
            }

            .fa-lock {
                color: #fff;
                font-size: 14px;
            }
        `;
        document.head.appendChild(newStyles);

        async function showLivestreamOverlay() {
            // Create overlay container
            const overlayContainer = document.createElement('div');
            overlayContainer.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 70%;
                background: rgba(0, 0, 0, 0.95);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                transform: translateY(100%);
                transition: transform 0.3s ease-out;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px;
            `;

            // Get livestream data from Firestore
            const livestreamRef = doc(db, "livestream", "current");
            const livestreamDoc = await getDoc(livestreamRef);
            const livestreamData = livestreamDoc.data() || {
                description: "No active livestream",
                link: "#",
                reward: 0,
                isActive: false
            };

            // Check cooldown status before showing the overlay
            const user = auth.currentUser;
            let initialButtonState = '';
            let isInCooldown = false;
            let remainingTime = 0;

            if (user) {
                const cooldownRef = doc(db, "livestreamCooldowns", user.uid);
                const cooldownDoc = await getDoc(cooldownRef);
                
                if (cooldownDoc.exists()) {
                    const cooldownData = cooldownDoc.data();
                    const cooldownEnd = cooldownData.cooldownEnd?.toDate();
                    const now = new Date();
                    
                    if (cooldownEnd && now < cooldownEnd) {
                        isInCooldown = true;
                        remainingTime = Math.ceil((cooldownEnd - now) / 1000);
                        const minutes = Math.floor(remainingTime / 60);
                        const seconds = remainingTime % 60;
                        initialButtonState = `next code in ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            }

            // Create content with conditional button state
            overlayContainer.innerHTML = `
                <div style="width: 100%; text-align: right;">
                    <button id="close-livestream" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                </div>
                <h2 style="color: #ec8f04; margin: 10px 0;">Live Stream Event</h2>
                <p style="color: white; margin: 20px 0; text-align: center; padding: 0 20px;">
                    ${livestreamData.description}
                </p>
                <div style="display: flex; gap: 20px; margin-top: 20px;">
                    <button id="join-livestream" style="
                        background: #ec8f04;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-weight: bold;
                    ">Join Livestream</button>
                </div>
                <div style="margin-top: 20px; width: 80%; max-width: 300px;">
                    <input type="text" id="livestream-code" placeholder="Enter verification code" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ec8f04;
                        border-radius: 5px;
                        background: rgba(255, 255, 255, 0.1);
                        color: white;
                        margin-bottom: 10px;
                    ">
                    <button id="verify-code" style="
                        width: 100%;
                        background: ${isInCooldown ? '#666' : '#19e2b0'};
                        color: white;
                        border: none;
                        padding: 10px;
                        border-radius: 5px;
                        cursor: ${isInCooldown ? 'not-allowed' : 'pointer'};
                        font-weight: bold;
                    " ${isInCooldown ? 'disabled' : ''}>${isInCooldown ? initialButtonState : 'Verify Code'}</button>
                </div>
                <p id="verification-message" style="color: white; margin-top: 10px;"></p>
            `;

            document.body.appendChild(overlayContainer);

            // Show overlay with animation
            setTimeout(() => {
                overlayContainer.style.transform = 'translateY(0)';
            }, 100);

            // Add event listeners
            document.getElementById('close-livestream').onclick = () => {
                overlayContainer.style.transform = 'translateY(100%)';
                setTimeout(() => overlayContainer.remove(), 300);
            };

            document.getElementById('join-livestream').onclick = () => {
                if (livestreamData.isActive && livestreamData.link) {
                    window.open(livestreamData.link, '_blank');
                } else {
                    alert('No active livestream available at the moment.');
                }
            };

            document.getElementById('verify-code').onclick = async () => {
                const code = document.getElementById('livestream-code').value;
                const messageElement = document.getElementById('verification-message');
                const verifyButton = document.getElementById('verify-code');
                
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        messageElement.style.color = 'red';
                        messageElement.textContent = 'Please log in to verify.';
                        return;
                    }

                    // Check if user is in cooldown period
                    const cooldownRef = doc(db, "livestreamCooldowns", user.uid);
                    const cooldownDoc = await getDoc(cooldownRef);
                    
                    if (cooldownDoc.exists()) {
                        const cooldownData = cooldownDoc.data();
                        const cooldownEnd = cooldownData.cooldownEnd?.toDate();
                        const now = new Date();
                        
                        if (cooldownEnd && now < cooldownEnd) {
                            const remainingTime = Math.ceil((cooldownEnd - now) / 1000 / 60); // remaining minutes
                            messageElement.style.color = 'red';
                            messageElement.textContent = `Please wait ${remainingTime} minute(s) before trying again.`;
                            
                            // Update button to show remaining time
                            verifyButton.disabled = true;
                            verifyButton.style.backgroundColor = '#666';
                            
                            const remainingSeconds = Math.ceil((cooldownEnd - now) / 1000);
                            startCountdown(verifyButton, remainingSeconds);
                            return;
                        }
                    }
                    
                    if (code === livestreamData.code) {
                        try {
                            // First update the user's balance
                            await updateBalance(user.uid, livestreamData.reward);
                            messageElement.style.color = '#19e2b0';
                            messageElement.textContent = `Congratulations! You've earned ${livestreamData.reward} 2KCoins!`;
                            
                            // Record the verification
                            const userVerificationRef = doc(db, "livestreamVerifications", user.uid);
                            await setDoc(userVerificationRef, {
                                verified: true,
                                timestamp: serverTimestamp(),
                                streamId: livestreamData.streamId,
                                rewardAmount: livestreamData.reward
                            });

                            // Set cooldown period using server timestamp
                            await setDoc(cooldownRef, {
                                cooldownEnd: serverTimestamp(5 * 60 * 1000), // 5 minutes from server time
                                lastVerification: serverTimestamp()
                            });

                            // Start countdown
                            verifyButton.disabled = true;
                            verifyButton.style.backgroundColor = '#666';
                            startCountdown(verifyButton, 300); // 5 minutes in seconds

                        } catch (error) {
                            console.error("Error processing verification:", error);
                            messageElement.style.color = 'red';
                            messageElement.textContent = 'Error processing verification. Please try again.';
                        }
                    } else {
                        messageElement.style.color = 'red';
                        messageElement.textContent = 'Invalid code. Please try again.';
                    }
                } catch (error) {
                    console.error("Error checking cooldown:", error);
                    messageElement.style.color = 'red';
                    messageElement.textContent = 'Error checking verification status. Please try again.';
                }
            };

            // If in cooldown, start the countdown immediately
            if (isInCooldown) {
                const verifyButton = document.getElementById('verify-code');
                startCountdown(verifyButton, remainingTime);
            }
        }

        // Add this helper function for the countdown
        function startCountdown(button, seconds) {
            let remainingSeconds = seconds;
            const countdownInterval = setInterval(() => {
                remainingSeconds--;
                const minutes = Math.floor(remainingSeconds / 60);
                const secs = remainingSeconds % 60;
                button.textContent = `next code in ${minutes}:${secs.toString().padStart(2, '0')}`;
                
                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    button.disabled = false;
                    button.style.backgroundColor = '#19e2b0';
                    button.textContent = 'Verify Code';
                }
            }, 1000);
        }

        // Function to detect if the user is on a mobile device
        function isMobileDevice() {
            return /Mobi|Android/i.test(navigator.userAgent);
        }

        // Function to display a campaign
        function displayCampaign(campaign) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';

            const campaignContent = document.createElement('div');
            campaignContent.className = 'campaign-content';

            const countdownDuration = campaign.contentType === 'video' ? 30 : 15; // 30 seconds for video, 15 for pic
            let countdown = countdownDuration;

            const countdownTimer = document.createElement('div');
            countdownTimer.className = 'countdown-timer';
            countdownTimer.textContent = ` ${countdown} `;
            countdownTimer.style.backgroundColor = '#000';
            countdownTimer.style.position = 'absolute'; // Position it absolutely
            countdownTimer.style.top = '10px'; // Position from the top
            countdownTimer.style.left = '20px'; // Position from the left
            countdownTimer.style.color = '#fff'; // White text color
            countdownTimer.style.borderRadius = '5px'; // Rounded corners

            if (campaign.contentType === 'video') {
                campaignContent.innerHTML += `
                    <div class="video-wrapper">
                        <video id="ad-video" src="${campaign.contentURL}" autoplay muted playsinline></video>
                        <div class="banner" style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="logo-name" style="display: flex; align-items: center;">
                                <img src="${campaign.logoURL || 'default-logo.png'}" alt="Logo" class="logo">
                                <span style="color: #fff; margin-left: 10px;">${campaign.name || 'App Name'}</span>
                            </div>
                            <a href="${getCampaignLink(campaign)}" target="_blank" class="action-link" style="margin-left: auto;">
                                ${campaign.type === 'app' ? 'Install App' : 'Visit Web'}
                            </a>
                        </div>
                    </div>
                `;
            } else if (campaign.contentType === 'pic') {
                campaignContent.innerHTML += `
                    <div class="image-wrapper">
                        <img src="${campaign.contentURL}" alt="${campaign.name || 'Campaign Image'}" class="campaign-image">
                        <div class="banner" style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="logo-name" style="display: flex; align-items: center;">
                                <img src="${campaign.logoURL || 'default-logo.png'}" alt="Logo" class="logo">
                                <span style="color: #fff; margin-left: 10px;">${campaign.name || 'App Name'}</span>
                            </div>
                            <a href="${getCampaignLink(campaign)}" target="_blank" class="action-link" style="margin-left: auto;">
                                ${campaign.type === 'app' ? 'Install App' : 'Visit Web'}
                            </a>
                        </div>
                    </div>
                `;
            }

            campaignContent.appendChild(countdownTimer);
            overlay.appendChild(campaignContent);
            document.body.appendChild(overlay);

            // Countdown logic
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownTimer.textContent = ` ${countdown} `;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    rewardUser(campaign.userId);
                    countdownTimer.style.display = 'none';

                    // Create reward message with close button
                    const rewardMessage = document.createElement('div');
                    rewardMessage.className = 'reward-message';
                    rewardMessage.style.fontSize = '12px';
                    rewardMessage.style.fontWeight = 'bold';
                    rewardMessage.style.backgroundColor = '#000';
                    rewardMessage.style.position = 'absolute'; // Position it absolutely
                    rewardMessage.style.top = '10px'; // Position from the top
                    rewardMessage.style.left = '40px'; // Position from the left
                    rewardMessage.style.color = '#fff';  
                    rewardMessage.innerHTML = '<button class="close-button" style="background: #000; border: none; color: #fff; border-radius: 100%; width: 10px; height: 20px; display: inline-flex; align-items: center; justify-content: center; margin-right: 80px; margin-top: -14px;" onclick="document.body.removeChild(this.closest(\'.overlay\'))">&times;</button> Reward granted!';

                    campaignContent.appendChild(rewardMessage);
                }
            }, 1000);
        }

        // Function to reward the user
        async function rewardUser(userId) {
            try {
                await updateBalance(userId, 20); // Assuming updateBalance is a function that updates the user's balance
                console.log('User rewarded with 20 2KCoins');
            } catch (error) {
                console.error('Error rewarding user:', error);
            }
        }

        // Function to get the appropriate campaign link
        function getCampaignLink(campaign) {
            const userDevice = getUserDevice();
            if (campaign.type === 'app') {
                if (userDevice === 'android') {
                    return campaign.androidLink;
                } else if (userDevice === 'ios') {
                    return campaign.iosLink;
                }
            }
            return campaign.link; // Use the provided link for other types
        }

        // Function to detect the user's device
        function getUserDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            if (/android/i.test(userAgent)) {
                return 'android';
            }
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return 'ios';
            }
            return 'web';
        }

        // Function to check if the app is installed
        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches;
        }

        // Function to show the install banner
        function showInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.style.display = 'block'; // Show the banner
        }

        // Check if the app is installed
        if (!isAppInstalled()) {
            showInstallBanner(); // Show the banner if not installed
        }

        // Close banner and reward user
        document.getElementById('closeBanner').onclick = function() {
            document.getElementById('installBanner').style.display = 'none'; // Hide the banner without rewarding
        };

        // Add this function to handle the installation
        document.getElementById('installButton').onclick = function() {
            // Hide the banner when the user installs the app
            document.getElementById('installBanner').style.display = 'none'; // Hide the banner
            // Optionally, you can add logic to trigger the installation prompt here
        };

        // Show instructions when the Install button is clicked
        document.getElementById('installButton').onclick = function() {
            const instruction = document.getElementById('instruction');
            instruction.style.display = instruction.style.display === 'none' ? 'block' : 'none'; // Toggle instruction visibility
        };

        async function loadBanners() {
            const bannersContainer = document.createElement('div');
            bannersContainer.style.position = 'absolute'; // Position it absolutely
            bannersContainer.style.top = '300px'; // Adjust this value to position it above the middle button
            bannersContainer.style.left = '50%'; // Center horizontally
            bannersContainer.style.transform = 'translateX(-50%)'; // Center the container
            bannersContainer.style.width = '300px'; // Set fixed width for the banner container
            bannersContainer.style.height = '100px'; // Set fixed height for the banner container
            bannersContainer.style.overflow = 'hidden'; // Hide overflow to show one banner at a time
            bannersContainer.style.zIndex = '10'; // Ensure it appears above other elements

            const bannerImage = document.createElement('img');
            bannerImage.style.width = '100%'; // Make the image fill the container
            bannerImage.style.height = '100%'; // Make the image fill the container
            bannerImage.style.objectFit = 'cover'; // Maintain aspect ratio
            bannersContainer.appendChild(bannerImage); // Append the image to the container

            document.body.appendChild(bannersContainer); // Append the banners container to the body

            try {
                const bannersCollection = collection(db, 'banners');
                const snapshot = await getDocs(bannersCollection);
                const banners = snapshot.docs.map(doc => doc.data()); // Store banners in an array

                if (banners.length > 0) {
                    let currentIndex = 0; // Start with the first banner
                    bannerImage.src = banners[currentIndex].imageUrl; // Set the initial banner image

                    // Function to change the banner every 20 seconds
                    setInterval(() => {
                        currentIndex = (currentIndex + 1) % banners.length; // Move to the next banner
                        bannerImage.src = banners[currentIndex].imageUrl; // Update the image source

                        // Add click event to redirect to the URL
                        bannerImage.onclick = () => {
                            window.location.href = banners[currentIndex].link; // Redirect to the current banner's link
                        };
                    }, 20000); // Change banner every 20 seconds
                } else {
                    console.warn("No banners found in Firestore.");
                }

            } catch (error) {
                console.error("Error loading banners:", error);
            }
        }

        // Call the loadBanners function after Firebase initialization
        loadBanners();
    </script>
    <script type='text/javascript' src='https://pl25145596.profitablecpmrate.com/a1/91/a1/a191a1a71e1bfd8cf2b8b436068db02a.js'></script>
 </body> 
</html>
