<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY DAILY2K Task</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset CSS */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(to top, #ec8f04, #000000);
            color: #f0f0f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .content {
            flex: 1;
            padding: 20px;
            text-align: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .task-list {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 40px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .task-list h2 {
            margin-bottom: 20px;
            font-size: 28px;
            color: #ffb84d;
        }

        .task-list ul {
            list-style: none;
            padding: 0;
        }

        .task-list li {
            background-color: #333;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }

        .task-list li:hover {
            background-color: #444;
        }

        .task-list li h3 {
            margin-bottom: 10px;
            font-size: 22px;
            color: #ec8f04;
        }

        .task-list li p {
            margin-bottom: 15px;
            font-size: 16px;
            line-height: 1.5;
        }

        .task-list li .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .task-list li button {
            flex: 1;
            min-width: 120px;
            background-color: #ec8f04;
            color: #000;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            padding: 10px 20px;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.3s;
        }

        .task-list li button:hover:not(:disabled) {
            background-color: #ffb84d;
            transform: scale(1.05);
        }

        .task-list li button:disabled {
            background-color: #888;
            cursor: not-allowed;
            transform: none;
        }

        .claim-button {
            background-color: #4CAF50 !important;
            color: #fff !important;
        }

        .claimed-label {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #4CAF50;
            color: #fff;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .code-input {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .code-input input {
            padding: 8px;
            border-radius: 5px;
            border: none;
            margin-bottom: 10px;
            font-size: 16px;
        }

        /* Bottom Banner */
        .bottom-banner {
    border-radius: 20px; /* Curved edges */
    overflow: hidden; /* Ensure content fits within the border */
    background-color: #222; /* Change background color */
    padding: 13px; /* Adjust padding */
    width: 75%; /* Set width */
    margin: 0px auto; /* Center the banner */
    position: fixed; /* Keep it fixed at the bottom */
    bottom: 20px;
    left: 50%; /* Center horizontally */
    transform: translateX(-50%); /* Adjust position to perfectly center */
    z-index: 1;
    display: flex;
    justify-content: space-around;
}
 
        .bottom-banner .button {
            width: 50px; /* Adjusted size for consistency */
            height: 50px;
            background-color: #ec8f04;
            color: #000;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 10px; /* Adjusted padding */
            font-size: 24px; /* Adjusted icon size */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s, transform 0.3s;
        }

        .bottom-banner .button:hover {
            background-color: #ec8f04;
            transform: scale(1.1);
        }

        .button-label {
            display: block;
            color: #fff;
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: #fff;
            padding: 15px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success {
            background-color: #4CAF50;
        }

        .notification.error {
            background-color: #f44336;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .task-list li h3 {
                font-size: 20px;
            }

            .task-list li p {
                font-size: 14px;
            }

            .task-list li button {
                font-size: 14px;
                padding: 8px 16px;
            }

            .bottom-banner .button {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .button-label {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .task-list {
                padding: 15px;
            }

            .task-list h2 {
                font-size: 24px;
            }

            .task-list li {
                padding: 10px;
            }

            .task-list li h3 {
                font-size: 18px;
            }

            .task-list li p {
                font-size: 14px;
            }

            .task-list li button {
                font-size: 14px;
                padding: 6px 12px;
            }

            .bottom-banner .button {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .button-label {
                font-size: 10px;
            }
        }
    </style>
</head>
<body> 
    <div class="content">
        <div class="task-list">
            <h2>Available Tasks</h2>
            <button onclick="loadTasks()">Reload Tasks</button>
            <ul id="taskList">
                <!-- Task items will be dynamically added here -->
            </ul>
        </div>
    </div>

    <div class="bottom-banner">
        <div class="button-container">
            <button class="button" onclick="window.location.href='dashboard.html'">
                <i class="fas fa-home"></i>
            </button>
            <span class="button-label">Dashboard</span>
        </div>
        <div class="button-container">
            <button class="button" onclick="window.location.href='withdraw.html'">
                <i class="fas fa-wallet"></i>
            </button>
            <span class="button-label">Withdraw</span>
        </div>
        <div class="button-container">
            <button class="button" onclick="window.location.href='friends.html'">
                <i class="fas fa-user-friends"></i>
            </button>
            <span class="button-label">Friends</span>
        </div>
        <div class="button-container">
            <button class="button" onclick="window.location.href='profile.html'">
                <i class="fas fa-user"></i>
            </button>
            <span class="button-label">Profile</span>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification" class="notification"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, increment, getDoc, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCpH_yjFtiib-QuaCnHy2qeVyXhXikWTFg",
            authDomain: "mydaily2kbot.firebaseapp.com",
            projectId: "mydaily2kbot",
            storageBucket: "mydaily2kbot.appspot.com",
            messagingSenderId: "967002689133",
            appId: "1:967002689133:web:e3a8d03eaf7cf2f1b7f964",
            measurementId: "G-2VNDPK8V4J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadTasks();
            } else {
                window.location.href = 'login.html'; // Redirect to login page
            }
        });

        async function loadTasks() {
            const taskListElement = document.getElementById("taskList");
            taskListElement.innerHTML = ''; // Clear existing tasks

            try {
                const tasksSnapshot = await getDocs(collection(db, "tasks"));

                if (tasksSnapshot.empty) {
                    taskListElement.innerHTML = '<li>No tasks available at the moment.</li>';
                    return;
                }

                const userTasksDoc = await getDoc(doc(db, "userTasks", currentUser.uid));
                const userTasks = userTasksDoc.exists() ? userTasksDoc.data() : {};

                tasksSnapshot.forEach(docSnap => {
                    const task = docSnap.data();
                    const taskId = docSnap.id;
                    const userTask = userTasks[taskId] || {};
                    const isClaimed = userTask.isClaimed === true;
                    const isVerified = userTask.isVerified === true;

                    const listItem = document.createElement("li");

                    listItem.innerHTML = `
                        <h3>${task.name} - ${task.reward} points</h3>
                        <p>${task.description}</p>
                        <div class="buttons">
                            <button class="do-task-button" onclick="doTask('${taskId}')" ${isClaimed ? 'disabled' : ''}>
                                Do Task
                            </button>
                            <button class="check-button" onclick="checkTask('${taskId}', ${task.reward}, ${task.requiresCode ? 'true' : 'false'})" ${!userTask.startTime || isClaimed ? 'disabled' : ''}>
                                Check
                            </button>
                            ${isClaimed ? `
                                <button class="claim-button" onclick="claimReward('${taskId}', ${task.reward})" disabled>
                                    Claim
                                </button>
                            ` : (userTask.isVerified || !task.requiresCode) && userTask.startTime ? `
                                <button class="claim-button" onclick="claimReward('${taskId}', ${task.reward})">
                                    Claim
                                </button>
                            ` : ''}
                        </div>
                        ${isClaimed ? `
                            <span class="claimed-label">Claimed</span>
                        ` : ''}
                        ${task.requiresCode && userTask.startTime && !isClaimed ? `
                            <div class="code-input" id="code-input-${taskId}" style="display: ${userTask.isVerified ? 'none' : 'flex'};">
                                <input type="text" id="code-${taskId}" placeholder="Enter verification code">
                            </div>
                        ` : ''}
                    `;
                    taskListElement.appendChild(listItem);
                });
            } catch (error) {
                console.error("Error loading tasks:", error);
                showNotification("Failed to load tasks. Please try again later.", "error");
            }
        }

        async function doTask(taskId) {
            try {
                const taskDoc = await getDoc(doc(db, "tasks", taskId));
                if (!taskDoc.exists()) {
                    showNotification("Task not found.", "error");
                    return;
                }
                const task = taskDoc.data();

                // Open the task link in a new tab
                window.open(task.link, '_blank');

                // Record the start time in Firestore
                const userTaskRef = doc(db, "userTasks", currentUser.uid);
                const userTaskDoc = await getDoc(userTaskRef);
                const userTasks = userTaskDoc.exists() ? userTaskDoc.data() : {};

                await setDoc(userTaskRef, {
                    [taskId]: {
                        startTime: new Date(),
                        isVerified: false,
                        isClaimed: false
                    }
                }, { merge: true });

                showNotification("Task started! Please complete it as required.", "success");
                loadTasks(); // Reload tasks to update UI
            } catch (error) {
                console.error("Error starting task:", error);
                showNotification("Failed to start the task. Please try again later.", "error");
            }
        }

        async function checkTask(taskId, reward, requiresCode) {
            try {
                const userTaskRef = doc(db, "userTasks", currentUser.uid);
                const userTaskDoc = await getDoc(userTaskRef);

                if (!userTaskDoc.exists() || !userTaskDoc.data()[taskId]) {
                    showNotification("Please click 'Do Task' before checking.", "error");
                    return;
                }

                const userTask = userTaskDoc.data()[taskId];
                const startTime = userTask.startTime.toDate();
                const currentTime = new Date();
                const elapsedTime = (currentTime - startTime) / 1000; // in seconds

                // Fetch the time limit from the task document
                const taskDoc = await getDoc(doc(db, "tasks", taskId));
                if (!taskDoc.exists()) {
                    showNotification("Task not found.", "error");
                    return;
                }
                const task = taskDoc.data();
                const timeLimit = task.timeLimit || 0;

                if (elapsedTime < timeLimit) {
                    const remainingTime = Math.ceil(timeLimit - elapsedTime);
                    showNotification(`Task is incompleted.`, "error");
                    return;
                }

                if (requiresCode) {
                    const codeInput = document.getElementById(`code-${taskId}`).value.trim();
                    if (!codeInput) {
                        showNotification("Please enter the verification code.", "error");
                        return;
                    }

                    if (codeInput !== (task.verificationCode || "")) {
                        showNotification("Incorrect verification code. Please try again.", "error");
                        return;
                    }

                    // Update Firestore to mark as verified
                    await updateDoc(userTaskRef, {
                        [`${taskId}.isVerified`]: true
                    });

                    showNotification("Verification successful! You can now claim your reward.", "success");
                } else {
                    showNotification("Task completed! You can now claim your reward.", "success");
                }

                loadTasks(); // Reload tasks to update UI
            } catch (error) {
                console.error("Error checking task:", error);
                showNotification("Failed to check the task. Please try again later.", "error");
            }
        }

        async function claimReward(taskId, reward) {
            if (!currentUser) {
                showNotification("Please log in to claim rewards.", "error");
                return;
            }

            try {
                const userTasksRef = doc(db, "userTasks", currentUser.uid);
                const userTasksDoc = await getDoc(userTasksRef);
                const userTasks = userTasksDoc.exists() ? userTasksDoc.data() : {};

                if (userTasks[taskId]?.isClaimed) {
                    showNotification("You have already claimed this reward.", "error");
                    return;
                } 
                // Update user balance
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, {
                    balance: increment(reward)
                });

                // Mark the task as claimed
                await updateDoc(userTasksRef, {
                    [`${taskId}.isClaimed`]: true
                });

                showNotification(`Claimed ${reward} points!`, "success");
                loadTasks(); // Reload tasks to update UI
            } catch (error) {
                console.error("Error claiming reward:", error);
                showNotification("Failed to claim reward. Please try again later.", "error");
            }
        }

        // Notification Function
        function showNotification(message, type) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove("show");
            }, 3000);
        }

        // Expose these functions to the global scope
        window.checkTask = checkTask;
        window.claimReward = claimReward;
        window.loadTasks = loadTasks;
        window.doTask = doTask;
    </script>
</body>
</html>
