<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Contest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(to top, #ec8f04, #f58c79);
            color: #f0f0f0;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            line-height: 1.6;
        }
        body.light-mode {
            background: linear-gradient(to top, #ec8f04, black); /* Change to black in light mode */
        }

        .header {
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .upload-section {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
        }

        .steps-container h3 {
            text-align: center;
            color: #ec8f04;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .step-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .step-number {
            background: #ec8f04;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex-grow: 1;
        }

        .step-content h4 {
            color: #ec8f04;
            margin: 0 0 10px 0;
        }

        .step-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .step-content ul li {
            margin-bottom: 10px;
        }

        .link-input {
            position: relative;
            margin-top: 10px;
        }

        .link-input input {
            width: 93%;
            padding: 10px;
            padding-right: 40px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .link-input i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #ec8f04;
        }

        .verify-btn, .upload-btn {
            background: #ec8f04;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .verify-btn:hover, .upload-btn:hover {
            background: #ff9f04;
        }

        .message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.3);
            color: #F44336;
        }

        @media (max-width: 600px) {
            .step-box {
                flex-direction: column;
            }

            .step-number {
                margin-bottom: 10px;
            }
        }

        .contest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .contest-entry {
            background-color: rgba(0, 0, 0, 0.7);
            width: 50%;
            border-radius: 10px;
            text-align: center;
            margin-left: 25%;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .contest-video {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            background-color: #000;
        }

        .entry-details {
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .entry-details h3 {
            margin: 0;
            color: #ec8f04;
            font-size: 1.2em;
        }

        .entry-details p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .vote-share-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .vote-btn {
            background-color: #ec8f04;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .share-btn {
            background-color: #4267B2;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .timer-section {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ec8f04;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .contest-status {
            text-align: center;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            margin: 10px auto;
            max-width: 600px;
            border-radius: 10px;
        }

        .search-container {
            display: flex;
            justify-content: center;
            margin: 20px auto;
            max-width: 600px;
            gap: 10px;
        }

        .search-container input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .search-btn {
            background: #ec8f04;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            color: white;
            cursor: pointer;
        }

        .contest-progress {
            max-width: 600px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .progress-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #ec8f04;
            transition: width 0.3s ease;
        }

        .slots-alert {
            color: #ec8f04;
            text-align: center;
            margin-top: 5px;
            font-weight: bold;
        }

        .leaderboard {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
        }

        .leaderboard h2 {
            text-align: center;
            color: #ec8f04;
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
            color: #ec8f04;
        }

        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards;
            z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }

        @media (max-width: 768px) {
            .contest-entry {
                width: 90%;
                margin: 10px auto;
            }

            .contest-video {
                height: auto;
                max-height: 250px;
            }
        }

        .loading-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }

        .loading-indicator p {
            margin-top: 10px;
            text-align: center;
        }

        .leaderboards-container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .leaderboard {
            flex: 1;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
        }

        .prize-info {
            font-size: 1.5em;
            color: #ec8f04;
            margin: 10px 0;
        }

        .winner-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ec8f04;
            color: white;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .leaderboards-container {
                flex-direction: column;
            }
        }

        .social-verification {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .requirement-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            width: 280px;
            text-align: center;
        }

        .requirement-box i {
            font-size: 2em;
            margin-bottom: 10px;
            color: #ec8f04;
        }

        .social-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .tag-info {
            font-size: 0.9em;
            color: #ec8f04;
            margin-top: 5px;
        }

        .verify-btn {
            background: #ec8f04;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s;
        }

        .verify-btn:hover {
            background: #ff9f04;
        }

        .verification-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .verification-status.success {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .verification-status.error {
            background: rgba(244, 67, 54, 0.3);
            color: #F44336;
        }

        .filters-section {
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
        }

        .filter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .filter-select {
            padding: 8px 15px;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.1);
            color: white;
            border: 1px solid #ec8f04;
        }

        .theme-toggle {
            background: transparent;
            border: 1px solid #ec8f04;
            color: #ec8f04;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
        }

        .top-contenders {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
        }

        .top-contenders h2 {
            color: #ec8f04;
            text-align: center;
            margin-bottom: 20px;
        }

        .contenders-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .contender-card {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .rank-badge {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            background: #ec8f04;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .contenders-grid {
                grid-template-columns: 1fr;
            }
        }

        .contest-info {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .prize-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .prize-card {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #ec8f04;
        }

        .prize-card i {
            font-size: 2em;
            color: #ec8f04;
            margin-bottom: 10px;
        }

        .prize-amount {
            font-size: 1.5em;
            color: #ec8f04;
            margin: 10px 0;
        }

        .prize-desc {
            color: #ffffff;
            font-size: 0.9em;
        }

        .contest-tips {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .contest-tips h3 {
            color: #ec8f04;
            margin-bottom: 15px;
        }

        .contest-tips ul {
            list-style-type: none;
            padding: 0;
        }

        .contest-tips li {
            margin: 10px 0;
            padding-left: 20px;
            position: relative;
        }

        .contest-tips li:before {
            content: '‚Ä¢';
            color: #ec8f04;
            position: absolute;
            left: 0;
        }

        .contender-card {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .contender-card:hover {
            transform: translateY(-5px);
        }

        .contender-card .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
        }

        /* Updated styles for better accessibility and engagement */
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(to top, #ec8f04, #f58c79);
            color: #f0f0f0;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            line-height: 1.6; /* Improved readability */
        }

        .header {
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .prize-info {
            font-size: 1.5em; /* Increased font size for visibility */
            color: #ec8f04;
            margin: 10px 0;
        }

        .step-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .step-content ul li {
            margin-bottom: 10px; /* Increased spacing for better readability */
        }

        .progress-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px; /* Added margin for spacing */
        }

        .progress-fill {
            height: 100%;
            background: #ec8f04;
            transition: width 0.3s ease;
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .rank-badge {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
            color: #ec8f04;
        }

        /* Responsive styles */
        @media (max-width: 600px) {
            .contest-entry {
                width: 90%;
                margin: 10px auto;
            }
                .switch {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        align-items: center;
    }
    .switch a {
        margin-left: 10px;
        color: white;
        text-decoration: none;
        padding: 5px 10px;
        background-color: #555;
        border-radius: 5px;
    }
        }
    </style>
</head>
<body>
         <div class="switch">
            <a href="dashboard.html" style="background-color: #ec8f04; ">Dashboard</a> 
        </div>
    <div class="header">
        <h1>üéâ Join the Weekly Video Contest! üé•</h1>
        <p>Win up to <span class="prize-info">20,000 2KCoins!</span> Compete for amazing prizes and recognition!</p>
    </div>

    <div class="contest-info">
        <div class="prize-cards">
            <div class="prize-card">
                <i class="fas fa-trophy"></i>
                <h3>üèÜ Community Choice Winner</h3>
                <p class="prize-amount">20,000 2KCoins</p>
                <p class="prize-desc">Most voted video wins!</p>
            </div>
            <div class="prize-card">
                <i class="fas fa-star"></i>
                <h3>‚≠ê Admin's Choice Winner</h3>
                <p class="prize-amount">10,000 2KCoins</p>
                <p class="prize-desc">Best quality content wins!</p>
            </div>
        </div>
        <div class="contest-tips">
            <h3>üé• How to Win?</h3>
            <ul>
                <li>‚ú® Be Creative: Upload videos that stand out!</li>
                <li>üì£ Share with friends to get more votes!</li>
                <li>üéØ Follow all community guidelines!</li>
                <li>üîñ Use hashtags like <strong>#Daily2KAmbassador</strong>!</li>
            </ul>
        </div>
    </div>

    <div class="upload-section">
        <div class="steps-container">
            <h3>üöÄ How to Submit Your Video</h3>
            <div class="step-box">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>Post Your Video on TikTok</h4>
                    <ul>
                        <li>Upload your video to TikTok</li>
                        <li>Tag <strong>@Daily2K</strong> in your post</li>
                        <li>Use hashtag <strong>#Daily2KAmbassador</strong></li>
                    </ul>
                    <div class="link-input">
                        <input type="text" id="tiktokLink" placeholder="Paste your TikTok post link here">
                        <i class="fab fa-tiktok"></i>
                    </div> 
                </div>
            </div>
            <div class="step-box">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>Share on Facebook</h4>
                    <ul>
                        <li>Share your video on Facebook</li>
                        <li>Tag <strong>@Daily2KOfficial</strong></li>
                        <li>Use hashtag <strong>#Daily2KAmbassador</strong></li>
                    </ul>
                    <div class="link-input">
                        <input type="text" id="facebookLink" placeholder="Paste your Facebook post link here">
                        <i class="fab fa-facebook"></i>
                    </div>
                </div>
            </div>
            <div class="step-box">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>Submit for Verification</h4>
                    <button id="verifyLinks" class="verify-btn">
                        <i class="fas fa-check-circle"></i> Verify Posts
                    </button>
                    <div id="uploadSection" style="display: none;">
                        <input type="file" id="videoInput" accept="video/*" style="display: none;">
                        <button onclick="document.getElementById('videoInput').click()" class="upload-btn">
                            <i class="fas fa-upload"></i> Upload Video
                        </button>
                    </div>
                </div>
            </div>
                <div class="contest-progress">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <p class="slots-alert" id="slotsAlert"></p>
                </div>

    <div class="filters-section">
        <div class="filter-controls">
            <select id="sortFilter" class="filter-select">
                <option value="votes">Most Votes</option>
                <option value="recent">Most Recent</option>
            </select>
            <button id="toggleTheme" class="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <div class="top-contenders">
        <h2><i class="fas fa-crown"></i> Top 3 Contenders</h2>
        <div class="contenders-grid" id="topContenders"></div>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search by username...">
        <button class="search-btn">
            <i class="fas fa-search"></i>
        </button>
    </div>
  

            </div>
        </div>
    </div> 
    <div class="timer-section">
        <p>Contest ends in: <span id="countdown">Loading...</span></p>
    </div>

    <div class="leaderboards-container" id="leaderboardsSection" style="display: none;">
        <div class="leaderboard user-choice">
            <h2><i class="fas fa-trophy"></i> Community Choice</h2>
            <div class="prize-info">
                <i class="fas fa-coins"></i> Prize: 20,000 2KCoins
            </div>
            <div id="userChoiceEntries"></div>
        </div>
        
        <div class="leaderboard admin-choice">
            <h2><i class="fas fa-star"></i> Admin's Choice</h2>
            <div class="prize-info">
                <i class="fas fa-coins"></i> Prize: 10,000 2KCoins
            </div>
            <div id="adminChoiceEntry"></div>
        </div>
    </div>

    <div class="contest-grid" id="contestEntries">
        <!-- Contest entries will be dynamically added here -->
    </div> 

    <div id="loadingIndicator" class="loading-indicator">
        <div class="loading-spinner"></div>
        <p id="loadingText">Processing...</p>
    </div> 

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            doc, 
            query, 
            orderBy, 
            increment,
            where,
            getDoc,
            setDoc,
            onSnapshot,
            limit
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // Use the same Firebase config from dashboard.html
        const firebaseConfig = {
            apiKey: "AIzaSyCpH_yjFtiib-QuaCnHy2qeVyXhXikWTFg",
            authDomain: "mydaily2kbot.firebaseapp.com",
            projectId: "mydaily2kbot",
            storageBucket: "mydaily2kbot.appspot.com",
            messagingSenderId: "967002689133",
            appId: "1:967002689133:web:e3a8d03eaf7cf2f1b7f964",
            measurementId: "G-2VNDPK8V4J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Add function to check available slots
        async function checkAvailableSlots() {
            try {
                const q = query(collection(db, 'contestEntries'), 
                              where('weekNumber', '==', getCurrentWeekNumber()));
                const snapshot = await getDocs(q);
                const currentEntries = snapshot.size;
                const availableSlots = 10 - currentEntries;
                
                const slotsElement = document.getElementById('availableSlots');
                const alertElement = document.getElementById('slotsAlert');
                
                if (slotsElement) {
                    slotsElement.textContent = `${availableSlots} of 10 slots remaining`;
                }
                
                if (alertElement) {
                    if (availableSlots <= 2 && availableSlots > 0) {
                        alertElement.textContent = `‚ö†Ô∏è Only ${availableSlots} slot${availableSlots === 1 ? '' : 's'} left! Submit now!`;
                        alertElement.style.color = '#ff4444';
                    } else if (availableSlots === 0) {
                        alertElement.textContent = 'All slots filled for this week!';
                    } else {
                        alertElement.textContent = `${availableSlots} slots available`;
                    }
                }
                
                return availableSlots > 0;
            } catch (error) {
                console.error('Error checking slots:', error);
                return false;
            }
        }

        // Get used slots count
        async function getUsedSlots() {
            try {
                const q = query(
                    collection(db, 'contestEntries'),
                    where('weekNumber', '==', getCurrentWeekNumber())
                );
                const snapshot = await getDocs(q);
                return snapshot.size;
            } catch (error) {
                console.error('Error getting used slots:', error);
                return 0;
            }
        }

        // Update entry in DOM
        function updateEntryInDOM(entryId, entryData) {
            const existingEntry = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (existingEntry) {
                existingEntry.querySelector('.votes-count').textContent = `${entryData.votes} votes`;
                existingEntry.querySelector('.entry-username').textContent = entryData.username;
            }
        }

        // Append new entry
        function appendNewEntry(entryId, entryData) {
            const entriesContainer = document.getElementById('contestEntries');
            const entryElement = createEntryElement(entryData, entryId);
            entriesContainer.insertBefore(entryElement, entriesContainer.firstChild);
        }

        // Remove entry from DOM
        function removeEntryFromDOM(entryId) {
            const entry = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entry) {
                entry.remove();
            }
        }

        // Update createEntryElement function to include data attributes
        function createEntryElement(entry, entryId) {
            const div = document.createElement('div');
            div.className = 'contest-entry';
            div.setAttribute('data-entry-id', entryId);
            
            const timestamp = new Date(entry.timestamp);
            const formattedDate = timestamp.toLocaleDateString();
            const formattedTime = timestamp.toLocaleTimeString();

            div.innerHTML = `
                <video class="contest-video" src="${entry.videoUrl}" controls></video>
                <div class="entry-details">
                    <h3 class="entry-username">${entry.username}</h3>
                    <p class="votes-count">${entry.votes} votes</p>
                    <p class="upload-date">Uploaded on ${formattedDate} at ${formattedTime}</p>
                </div>
                <div class="vote-share-section">
                    <button class="vote-btn" onclick="handleVote('${entryId}')">
                        <i class="fas fa-heart"></i> Vote
                    </button>
                    <button class="share-btn" onclick="shareEntry('${entry.videoUrl}', '${entry.username}')">
                        <i class="fas fa-share"></i> Share
                    </button>
                </div>
            `;
            return div;
        }

        // Update loadContestEntries to use the new createEntryElement
        async function loadContestEntries() {
            const entriesContainer = document.getElementById('contestEntries');
            entriesContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading entries...</div>';

            try {
                const q = query(
                    collection(db, 'contestEntries'),
                    where('weekNumber', '==', getCurrentWeekNumber()),
                    orderBy('votes', 'desc')
                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    entriesContainer.innerHTML = '<div style="text-align: center; padding: 20px;">No entries yet for this week!</div>';
                    return;
                }

                entriesContainer.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const entry = doc.data();
                    const entryElement = createEntryElement(entry, doc.id);
                    entriesContainer.appendChild(entryElement);
                });
            } catch (error) {
                console.error('Error loading entries:', error);
                entriesContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Error loading entries. Please try again later.</div>';
            }
        }

        // Update initializeRealTimeUpdates to include error handling
        function initializeRealTimeUpdates() {
            try {
                const q = query(
                    collection(db, 'contestEntries'),
                    where('weekNumber', '==', getCurrentWeekNumber())
                );
                
                onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "modified") {
                            updateEntryInDOM(change.doc.id, change.doc.data());
                        } else if (change.type === "added") {
                            appendNewEntry(change.doc.id, change.doc.data());
                        } else if (change.type === "removed") {
                            removeEntryFromDOM(change.doc.id);
                        }
                    });
                    updateLeaderboard();
                    updateProgressBar();
                }, (error) => {
                    console.error("Error in real-time updates:", error);
                });
            } catch (error) {
                console.error("Error setting up real-time updates:", error);
            }
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Update progress bar
        async function updateProgressBar() {
            const totalSlots = 10;
            const usedSlots = await getUsedSlots();
            const percentage = (usedSlots / totalSlots) * 100;
            
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            const remainingSlots = totalSlots - usedSlots;
            const alertElement = document.getElementById('slotsAlert');
            
            if (remainingSlots <= 2 && remainingSlots > 0) {
                alertElement.textContent = `‚ö†Ô∏è Only ${remainingSlots} slot${remainingSlots === 1 ? '' : 's'} left! Submit now!`;
                alertElement.style.color = '#ff4444';
            } else if (remainingSlots === 0) {
                alertElement.textContent = 'All slots filled for this week!';
            } else {
                alertElement.textContent = `${remainingSlots} slots available`;
            }
        }

        // Update leaderboard
        async function updateLeaderboard() {
            const userChoiceDiv = document.getElementById('userChoiceEntries');
            const adminChoiceDiv = document.getElementById('adminChoiceEntry');
            
            try {
                // Get top voted entry
                const votesQuery = query(
                    collection(db, 'contestEntries'),
                    where('weekNumber', '==', getCurrentWeekNumber()),
                    orderBy('votes', 'desc'),
                    limit(1)
                );
                
                // Get admin's choice
                const adminChoiceQuery = query(
                    collection(db, 'adminChoice'),
                    where('weekNumber', '==', getCurrentWeekNumber())
                );

                const [votesSnapshot, adminChoiceSnapshot] = await Promise.all([
                    getDocs(votesQuery),
                    getDocs(adminChoiceQuery)
                ]);

                // Update user choice section
                userChoiceDiv.innerHTML = '';
                votesSnapshot.forEach(doc => {
                    const entry = doc.data();
                    userChoiceDiv.innerHTML += `
                        <div class="leaderboard-entry" style="display: block;">
                            <div style="position: relative;">
                                <video class="contest-video" src="${entry.videoUrl}" controls style="width: 100%;"></video>
                                <div class="winner-badge"><i class="fas fa-trophy"></i></div>
                            </div>
                            <div class="entry-details" style="text-align: center; padding: 10px;">
                                <h3 style="margin: 10px 0;">${entry.username}</h3>
                                <p style="margin: 5px 0;">${entry.votes} votes</p>
                                ${isSunday() ? '<p class="winner-prize" style="color: #ec8f04; margin-top: 5px;">Winner! +20,000 2KCoins</p>' : ''}
                            </div>
                        </div>
                    `;
                });

                // Update admin choice section
                adminChoiceDiv.innerHTML = '';
                for (const doc of adminChoiceSnapshot.docs) {
                    const choice = doc.data();
                    if (choice.entryId) {
                        const entryDoc = await getDoc(doc(db, 'contestEntries', choice.entryId));
                        if (entryDoc.exists()) {
                            const entry = entryDoc.data();
                            adminChoiceDiv.innerHTML += `
                                <div class="leaderboard-entry" style="display: block;">
                                    <div style="position: relative;">
                                        <video class="contest-video" src="${entry.videoUrl}" controls style="width: 100%;"></video>
                                        <div class="winner-badge"><i class="fas fa-star"></i></div>
                                    </div>
                                    <div class="entry-details" style="text-align: center; padding: 10px;">
                                        <h3 style="margin: 10px 0;">${entry.username}</h3>
                                        ${isSunday() ? '<p class="winner-prize" style="color: #ec8f04; margin-top: 5px;">Winner! +10,000 2KCoins</p>' : ''}
                                    </div>
                                </div>
                            `;
                        }
                    }
                }

                // If it's Sunday, distribute prizes
                if (isSunday()) {
                    await distributePrizes(votesSnapshot, adminChoiceSnapshot);
                }
            } catch (error) {
                console.error('Error updating leaderboard:', error);
            }
        }

        // Add function to distribute prizes
        async function distributePrizes(votesSnapshot, adminChoiceSnapshot) {
            try {
                // Get winners
                const communityWinner = votesSnapshot.docs[0];
                const adminWinner = adminChoiceSnapshot.docs[0];

                if (communityWinner) {
                    const communityWinnerData = communityWinner.data();
                    await updateUserBalance(communityWinnerData.userId, 20000);
                }

                if (adminWinner) {
                    const adminWinnerData = adminWinner.data();
                    const entryDoc = await getDoc(doc(db, 'contestEntries', adminWinnerData.entryId));
                    if (entryDoc.exists()) {
                        await updateUserBalance(entryDoc.data().userId, 10000);
                    }
                }
            } catch (error) {
                console.error('Error distributing prizes:', error);
            }
        }

        // Add function to update user balance
        async function updateUserBalance(userId, amount) {
            const userRef = doc(db, 'users', userId);
            await updateDoc(userRef, {
                balance: increment(amount)
            });
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const entries = document.querySelectorAll('.contest-entry');
            
            entries.forEach(entry => {
                const username = entry.querySelector('h3').textContent.toLowerCase();
                entry.style.display = username.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // Add function to get username
        async function getUserUsername(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists() && userDoc.data().username) {
                    return userDoc.data().username;
                }
                return null;
            } catch (error) {
                console.error('Error getting username:', error);
                return null;
            }
        }

        // Update video upload handler
        document.getElementById('videoInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingText = document.getElementById('loadingText');

            try {
                // File validation
                if (file.size > 200 * 1024 * 1024) {
                    throw new Error('Video size must be less than 200MB');
                }
                if (!file.type.startsWith('video/')) {
                    throw new Error('Please upload a valid video file');
                }

                loadingIndicator.style.display = 'block';
                loadingText.textContent = 'Uploading video... this will take a min';

                // Check if slots are available
                const slotsAvailable = await checkAvailableSlots();
                if (!slotsAvailable) {
                    alert('Sorry, all slots for this week are filled!');
                    return;
                }

                // Check if user has already submitted
                const existingEntry = await checkExistingEntry(auth.currentUser.uid);
                if (existingEntry) {
                    alert('You have already submitted an entry for this week!');
                    return;
                }

                // Get username from users collection
                const username = await getUserUsername(auth.currentUser.uid);
                if (!username) {
                    throw new Error('Could not find your username. Please ensure your profile is set up correctly.');
                }

                // Upload video to Firebase Storage
                const videoRef = ref(storage, `contest-videos/${Date.now()}-${file.name}`);
                await uploadBytes(videoRef, file);
                const videoUrl = await getDownloadURL(videoRef);

                // Save entry to Firestore
                const contestEntry = {
                    userId: auth.currentUser.uid,
                    username: username, // Use the username from users collection
                    videoUrl: videoUrl,
                    votes: 0,
                    timestamp: Date.now(),
                    weekNumber: getCurrentWeekNumber()
                };

                await addDoc(collection(db, 'contestEntries'), contestEntry);
                showSuccess('Video uploaded successfully!');
                updateProgressBar();
                updateLeaderboard();
            } catch (error) {
                console.error('Error uploading:', error);
                alert(`Upload failed: ${error.message}`);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        });

        // Add function to check existing entry
        async function checkExistingEntry(userId) {
            const q = query(
                collection(db, 'contestEntries'),
                where('userId', '==', userId),
                where('weekNumber', '==', getCurrentWeekNumber())
            );
            const snapshot = await getDocs(q);
            return !snapshot.empty;
        }

        // Update share functionality
        window.shareEntry = (videoUrl, username) => {
            const shareText = `Please vote for ${username} on Daily2K Weekly Ambassador! üèÜ #Daily2K #WeeklyAmbassador`;
            if (navigator.share) {
                navigator.share({
                    title: 'Daily2K Weekly Ambassador Contest',
                    text: shareText,
                    url: videoUrl
                });
            } else {
                const dummy = document.createElement('textarea');
                document.body.appendChild(dummy);
                dummy.value = `${shareText}\n${videoUrl}`;
                dummy.select();
                document.execCommand('copy');
                document.body.removeChild(dummy);
                showSuccess('Link and message copied to clipboard!');
            }
        };

        // Helper functions
        function showLoading(show) {
            const loading = document.querySelector('.loading');
            if (show) {
                if (!loading) {
                    const div = document.createElement('div');
                    div.className = 'loading';
                    div.innerHTML = '<div class="loading-spinner"></div>';
                    document.body.appendChild(div);
                }
            } else {
                if (loading) loading.remove();
            }
        }

        function getCurrentWeekNumber() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            return Math.ceil(((now - start) / 86400000 + start.getDay() + 1) / 7);
        }

        // Update countdown timer
        function updateCountdown() {
            const now = new Date();
            const endOfWeek = new Date();
            endOfWeek.setDate(now.getDate() + (7 - now.getDay()));
            endOfWeek.setHours(23, 59, 59, 999);

            const timeLeft = endOfWeek - now;
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            document.getElementById('countdown').textContent = 
                `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        // Initialize
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                await checkAvailableSlots(); // Check slots initially
                initializeRealTimeUpdates();
                updateProgressBar();
                updateLeaderboard();
                setInterval(updateCountdown, 1000);
            }
        });

        // Update vote handler
        window.handleVote = async (entryId) => {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingText.textContent = 'Processing vote...';
            loadingIndicator.style.display = 'block';

            try {
                const user = auth.currentUser;
                if (!user) {
                    alert('Please login to vote');
                    return;
                }

                // Check if user has already voted
                const votesRef = doc(db, 'votes', `${entryId}_${user.uid}`);
                const voteDoc = await getDoc(votesRef);
                
                if (voteDoc.exists()) {
                    alert('You have already voted for this entry!');
                    return;
                }

                // Record the vote
                await setDoc(votesRef, {
                    userId: user.uid,
                    entryId: entryId,
                    timestamp: Date.now()
                });

                // Increment the vote count
                const entryRef = doc(db, 'contestEntries', entryId);
                await updateDoc(entryRef, {
                    votes: increment(1)
                });

                showSuccess('Thank you for voting!');
                updateLeaderboard();
            } catch (error) {
                alert(`Voting failed: ${error.message}`);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        };

        // Add function to check if it's Sunday
        function isSunday() {
            return new Date().getDay() === 0;
        }

        // Update validation function for TikTok instead of Twitter
        function isValidTikTokLink(link) {
            return link.includes('tiktok.com');
        }

        function isValidFacebookLink(link) {
            return link.includes('facebook.com');
        }

        // Check if user has already verified for this week
        async function checkExistingVerification() {
            try {
                if (!auth.currentUser) {
                    console.error('No user logged in');
                    return false;
                }

                const weekNumber = getCurrentWeekNumber();
                const verificationQuery = query(
                    collection(db, 'socialVerifications'),
                    where('userId', '==', auth.currentUser.uid),
                    where('weekNumber', '==', weekNumber)
                );
                
                const verificationSnapshot = await getDocs(verificationQuery);
                
                if (!verificationSnapshot.empty) {
                    document.getElementById('uploadSection').style.display = 'block';
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error checking verification:', error);
                return false;
            }
        }

        // Update verification function
        async function verifySocialPosts() {
            try {
                if (!auth.currentUser) {
                    throw new Error('Please log in to verify your posts');
                }

                const tiktokLink = document.getElementById('tiktokLink').value.trim();
                const facebookLink = document.getElementById('facebookLink').value.trim();
                
                if (!tiktokLink || !facebookLink) {
                    throw new Error('Please provide both TikTok and Facebook links');
                }

                if (!isValidTikTokLink(tiktokLink)) {
                    throw new Error('Invalid TikTok link format');
                }

                if (!isValidFacebookLink(facebookLink)) {
                    throw new Error('Invalid Facebook link format');
                }

                // Check for existing verification
                const existingVerification = await checkExistingVerification();
                if (existingVerification) {
                    throw new Error('You have already verified your social media posts for this week');
                }

                const verificationData = {
                    userId: auth.currentUser.uid,
                    tiktokLink,
                    facebookLink,
                    timestamp: Date.now(),
                    weekNumber: getCurrentWeekNumber()
                };

                // Add new verification
                await addDoc(collection(db, 'socialVerifications'), verificationData);
                showSuccess('Social media posts verified! You can now upload your video.');
                document.getElementById('uploadSection').style.display = 'block';
                
            } catch (error) {
                console.error('Verification error:', error);
                showError(error.message);
            }
        }

        // Add verify button click handler
        document.getElementById('verifyLinks').addEventListener('click', verifySocialPosts);

        // Check verification status on page load
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await checkExistingVerification();
            }
        });

        // Check if it's Sunday and manage display
        function checkIfSunday() {
            const today = new Date();
            const isSunday = today.getDay() === 0;
            const leaderboardsSection = document.getElementById('leaderboardsSection');
            const votingElements = document.querySelectorAll('.vote-btn');
            
            if (isSunday) {
                leaderboardsSection.style.display = 'flex';
                votingElements.forEach(btn => btn.style.display = 'none');
                loadWinners();
            } else {
                leaderboardsSection.style.display = 'none';
                votingElements.forEach(btn => btn.style.display = 'flex');
            }
        }

        // Load winners for both categories
        async function loadWinners() {
            try {
                // Get community choice winner (most votes)
                const q = query(
                    collection(db, 'contestEntries'),
                    where('weekNumber', '==', getCurrentWeekNumber()),
                    orderBy('votes', 'desc'),
                    limit(1)
                );
                
                const communitySnapshot = await getDocs(q);
                if (!communitySnapshot.empty) {
                    const winner = communitySnapshot.docs[0].data();
                    displayCommunityWinner(winner);
                }

                // Get admin's choice winner
                const adminChoiceDoc = await getDoc(doc(db, 'adminChoice', getCurrentWeekNumber().toString()));
                if (adminChoiceDoc.exists()) {
                    const adminChoice = adminChoiceDoc.data();
                    displayAdminWinner(adminChoice);
                }
            } catch (error) {
                console.error('Error loading winners:', error);
            }
        }

        // Display community choice winner
        function displayCommunityWinner(winner) {
            const winnerHTML = `
                <div class="winner-card">
                    <div class="winner-badge">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h3>${winner.username}</h3>
                    <video src="${winner.videoUrl}" controls class="winner-video"></video>
                    <p>${winner.votes} votes</p>
                    <p class="prize-won">Won 20,000 2KCoins</p>
                </div>
            `;
            document.getElementById('userChoiceEntries').innerHTML = winnerHTML;
        }

        // Display admin choice winner
        function displayAdminWinner(winner) {
            const winnerHTML = `
                <div class="winner-card">
                    <div class="winner-badge">
                        <i class="fas fa-star"></i>
                    </div>
                    <h3>${winner.username}</h3>
                    <video src="${winner.videoUrl}" controls class="winner-video"></video>
                    <p class="prize-won">Won 10,000 2KCoins</p>
                </div>
            `;
            document.getElementById('adminChoiceEntry').innerHTML = winnerHTML;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            checkIfSunday();
        });

        // Update the updateTopContenders function
        async function updateTopContenders() {
            try {
                const topContendersDiv = document.getElementById('topContenders');
                
                // Query the top 3 entries by votes
                const q = query(
                    collection(db, 'contestEntries'),
                    where('weekNumber', '==', getCurrentWeekNumber()),
                    orderBy('votes', 'desc'),
                    limit(3)
                );
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    topContendersDiv.innerHTML = '<p>No entries yet!</p>';
                    return;
                }

                // Clear existing content
                topContendersDiv.innerHTML = '';
                
                // Create elements for each top contender
                let position = 1;
                for (const doc of snapshot.docs) {
                    const entry = doc.data();
                    
                    // Get user's profile picture
                    const userDoc = await getDoc(doc(db, 'users', entry.userId));
                    const profilePic = userDoc.exists() ? 
                        userDoc.data().profilePicture || 'path/to/default/profile.png' : 
                        'path/to/default/profile.png';

                    const contenderCard = `
                        <div class="contender-card">
                            <div class="rank-badge">${position}</div>
                            <img src="${profilePic}" alt="Profile" class="profile-pic">
                            <h3>${entry.username}</h3>
                            <p>${entry.votes} votes</p>
                        </div>
                    `;
                    
                    topContendersDiv.innerHTML += contenderCard;
                    position++;
                }
            } catch (error) {
                console.error('Error updating top contenders:', error);
            }
        }
                // Check localStorage for the user's mode preference
                const currentMode = localStorage.getItem('mode') || 'dark';
        if (currentMode === 'light') {
            document.body.classList.add('light-mode'); // Apply light mode if set
        }
    </script>
</body>
</html> 
